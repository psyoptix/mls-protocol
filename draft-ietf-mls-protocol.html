<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>The Messaging Layer Security (MLS) Protocol</title>
<meta content="Richard Barnes" name="author">
<meta content="Benjamin Beurdouche" name="author">
<meta content="Jon Millican" name="author">
<meta content="Emad Omara" name="author">
<meta content="Katriel Cohn-Gordon" name="author">
<meta content="Raphael Robert" name="author">
<meta content="
       Messaging applications are increasingly making use of end-to-end
security mechanisms to ensure that messages are only accessible to
the communicating endpoints, and not to any servers involved in delivering
messages.  Establishing keys to provide such protections is
challenging for group chat settings, in which more than two
clients need to agree on a key but may not be online at the same
time.  In this document, we specify a key establishment
protocol that provides efficient asynchronous group key establishment
with forward secrecy and post-compromise security for groups
in size ranging from two to thousands. 
    " name="description">
<meta content="xml2rfc 3.2.1" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-ietf-mls-protocol-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.2.1
    Python 3.8.5
    appdirs 1.4.4
    ConfigArgParse 1.2.3
    google-i18n-address 2.4.0
    html5lib 1.1
    intervaltree 3.0.2
    Jinja2 2.11.2
    kitchen 1.2.6
    lxml 4.5.0
    pycountry 19.8.18
    pyflakes 2.1.1
    PyYAML 5.3.1
    requests 2.22.0
    setuptools 45.2.0
    six 1.14.0
-->
<link href="draft-ietf-mls-protocol.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@import url('https://martinthomson.github.io/i-d-template/fonts.css');

html {
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --small-font-size: 14.5px;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
#title {
  padding: 1em 0 0.2em;
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1, h2, h3 {
  font-size: 22px;
  line-height: 26px;
}
h4, h5, h6 {
  font-size: 18px;
  line-height: 22px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p, #abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 18px;
  line-height: 24px;
}
p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
dd.break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href].selfRef {
  color: var(--text-color);
}
a[href] {
  color: var(--link-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px 'Oxygen Mono', monospace;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  pre {
    display: inline-block;
    overflow-x: auto;
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  pre + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
  table {
    display: inline-block;
    overflow-x: auto;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
tr:nth-child(2n) > td {
  background-color: var(--background-color);
}
tr:nth-child(2n+1) > td {
  background-color: var(--highlight-color);
}
thead+tbody > tr:nth-child(2n) > td {
  background-color: var(--highlight-color);
}
thead+tbody > tr:nth-child(2n+1) > td {
  background-color: var(--background-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  visibility: hidden;
  user-select: none;
}
a.pilcrow[href] { color: #ddd; }
a.pilcrow[href]:hover { text-decoration: none; }
@media screen {
  :hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 8em;
}
#identifiers dt {
  width: var(--identifier-width);
  margin: 0;
  clear: left;
  float: left;
  text-align: right;
}
#identifiers dd {
  margin: 0 0 0 calc(1em + var(--identifier-width));
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 500px) {
  .index ul {
    column-count: 2;
    column-gap: 20px;
  }
  .index ul ul {
    column-count: 1;
    column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul p, #toc ul li {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table .text-left, table .text-left {
  text-align: left;
}
table .text-center, table .text-center {
  text-align: center;
}
table .text-right, table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
</style>

</head>
<body>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MLS</td>
<td class="right">October 2020</td>
</tr></thead>
<tfoot><tr>
<td class="left">Barnes, et al.</td>
<td class="center">Expires 25 April 2021</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-mls-protocol-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2020-10-22" class="published">22 October 2020</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2021-04-25">25 April 2021</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">R. Barnes</div>
<div class="org">Cisco</div>
</div>
<div class="author">
      <div class="author-name">B. Beurdouche</div>
<div class="org">Inria</div>
</div>
<div class="author">
      <div class="author-name">J. Millican</div>
<div class="org">Facebook</div>
</div>
<div class="author">
      <div class="author-name">E. Omara</div>
<div class="org">Google</div>
</div>
<div class="author">
      <div class="author-name">K. Cohn-Gordon</div>
<div class="org">University of Oxford</div>
</div>
<div class="author">
      <div class="author-name">R. Robert</div>
<div class="org">Wire</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">The Messaging Layer Security (MLS) Protocol</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">Messaging applications are increasingly making use of end-to-end
security mechanisms to ensure that messages are only accessible to
the communicating endpoints, and not to any servers involved in delivering
messages.  Establishing keys to provide such protections is
challenging for group chat settings, in which more than two
clients need to agree on a key but may not be online at the same
time.  In this document, we specify a key establishment
protocol that provides efficient asynchronous group key establishment
with forward secrecy and post-compromise security for groups
in size ranging from two to thousands.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-discussion-venues">
<a href="#name-discussion-venues" class="section-name selfRef">Discussion Venues</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">Source for this draft and an issue tracker can be found at
  <a href="https://github.com/mlswg/mls-protocol">https://github.com/mlswg/mls-protocol</a>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 25 April 2021.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2020 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a><a href="#section-toc.1-1.1.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="xref">1.1</a>.  <a href="#name-change-log" class="xref">Change Log</a><a href="#section-toc.1-1.1.2.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="xref">2</a>.  <a href="#name-terminology" class="xref">Terminology</a><a href="#section-toc.1-1.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-basic-assumptions" class="xref">Basic Assumptions</a><a href="#section-toc.1-1.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-protocol-overview" class="xref">Protocol Overview</a><a href="#section-toc.1-1.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-ratchet-trees" class="xref">Ratchet Trees</a><a href="#section-toc.1-1.5.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-tree-computation-terminolog" class="xref">Tree Computation Terminology</a><a href="#section-toc.1-1.5.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-ratchet-tree-nodes" class="xref">Ratchet Tree Nodes</a><a href="#section-toc.1-1.5.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="xref">5.3</a>.  <a href="#name-views-of-a-ratchet-tree" class="xref">Views of a Ratchet Tree</a><a href="#section-toc.1-1.5.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.5.2.4">
                <p id="section-toc.1-1.5.2.4.1"><a href="#section-5.4" class="xref">5.4</a>.  <a href="#name-ratchet-tree-evolution" class="xref">Ratchet Tree Evolution</a><a href="#section-toc.1-1.5.2.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.5.2.5">
                <p id="section-toc.1-1.5.2.5.1"><a href="#section-5.5" class="xref">5.5</a>.  <a href="#name-synchronizing-views-of-the-" class="xref">Synchronizing Views of the Tree</a><a href="#section-toc.1-1.5.2.5.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-cryptographic-objects" class="xref">Cryptographic Objects</a><a href="#section-toc.1-1.6.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="xref">6.1</a>.  <a href="#name-ciphersuites" class="xref">Ciphersuites</a><a href="#section-toc.1-1.6.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="xref">6.2</a>.  <a href="#name-credentials" class="xref">Credentials</a><a href="#section-toc.1-1.6.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-key-packages" class="xref">Key Packages</a><a href="#section-toc.1-1.7.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="xref">7.1</a>.  <a href="#name-client-capabilities" class="xref">Client Capabilities</a><a href="#section-toc.1-1.7.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="xref">7.2</a>.  <a href="#name-lifetime" class="xref">Lifetime</a><a href="#section-toc.1-1.7.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3" class="xref">7.3</a>.  <a href="#name-keypackage-identifiers" class="xref">KeyPackage Identifiers</a><a href="#section-toc.1-1.7.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.4">
                <p id="section-toc.1-1.7.2.4.1"><a href="#section-7.4" class="xref">7.4</a>.  <a href="#name-parent-hash" class="xref">Parent Hash</a><a href="#section-toc.1-1.7.2.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.5">
                <p id="section-toc.1-1.7.2.5.1"><a href="#section-7.5" class="xref">7.5</a>.  <a href="#name-tree-hashes" class="xref">Tree Hashes</a><a href="#section-toc.1-1.7.2.5.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.6">
                <p id="section-toc.1-1.7.2.6.1"><a href="#section-7.6" class="xref">7.6</a>.  <a href="#name-group-state" class="xref">Group State</a><a href="#section-toc.1-1.7.2.6.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.7">
                <p id="section-toc.1-1.7.2.7.1"><a href="#section-7.7" class="xref">7.7</a>.  <a href="#name-update-paths" class="xref">Update Paths</a><a href="#section-toc.1-1.7.2.7.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.8">
                <p id="section-toc.1-1.7.2.8.1"><a href="#section-7.8" class="xref">7.8</a>.  <a href="#name-key-schedule" class="xref">Key Schedule</a><a href="#section-toc.1-1.7.2.8.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.9">
                <p id="section-toc.1-1.7.2.9.1"><a href="#section-7.9" class="xref">7.9</a>.  <a href="#name-pre-shared-keys" class="xref">Pre-Shared Keys</a><a href="#section-toc.1-1.7.2.9.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.10">
                <p id="section-toc.1-1.7.2.10.1"><a href="#section-7.10" class="xref">7.10</a>. <a href="#name-encryption-keys" class="xref">Encryption Keys</a><a href="#section-toc.1-1.7.2.10.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.7.2.11">
                <p id="section-toc.1-1.7.2.11.1"><a href="#section-7.11" class="xref">7.11</a>. <a href="#name-exporters" class="xref">Exporters</a><a href="#section-toc.1-1.7.2.11.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-message-framing" class="xref">Message Framing</a><a href="#section-toc.1-1.8.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="xref">8.1</a>.  <a href="#name-content-signing" class="xref">Content Signing</a><a href="#section-toc.1-1.8.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="xref">8.2</a>.  <a href="#name-content-encryption" class="xref">Content Encryption</a><a href="#section-toc.1-1.8.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.8.2.3">
                <p id="section-toc.1-1.8.2.3.1"><a href="#section-8.3" class="xref">8.3</a>.  <a href="#name-sender-data-encryption" class="xref">Sender Data Encryption</a><a href="#section-toc.1-1.8.2.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="xref">9</a>.  <a href="#name-group-creation" class="xref">Group Creation</a><a href="#section-toc.1-1.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="xref">10</a>. <a href="#name-group-evolution" class="xref">Group Evolution</a><a href="#section-toc.1-1.10.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="xref">10.1</a>.  <a href="#name-proposals" class="xref">Proposals</a><a href="#section-toc.1-1.10.2.1.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.10.2.1.2.1">
                    <p id="section-toc.1-1.10.2.1.2.1.1"><a href="#section-10.1.1" class="xref">10.1.1</a>.  <a href="#name-add" class="xref">Add</a><a href="#section-toc.1-1.10.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="compact ulEmpty toc" id="section-toc.1-1.10.2.1.2.2">
                    <p id="section-toc.1-1.10.2.1.2.2.1"><a href="#section-10.1.2" class="xref">10.1.2</a>.  <a href="#name-update" class="xref">Update</a><a href="#section-toc.1-1.10.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="compact ulEmpty toc" id="section-toc.1-1.10.2.1.2.3">
                    <p id="section-toc.1-1.10.2.1.2.3.1"><a href="#section-10.1.3" class="xref">10.1.3</a>.  <a href="#name-remove" class="xref">Remove</a><a href="#section-toc.1-1.10.2.1.2.3.1" class="pilcrow">¶</a></p>
</li>
                  <li class="compact ulEmpty toc" id="section-toc.1-1.10.2.1.2.4">
                    <p id="section-toc.1-1.10.2.1.2.4.1"><a href="#section-10.1.4" class="xref">10.1.4</a>.  <a href="#name-external-proposals" class="xref">External Proposals</a><a href="#section-toc.1-1.10.2.1.2.4.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="xref">10.2</a>.  <a href="#name-commit" class="xref">Commit</a><a href="#section-toc.1-1.10.2.2.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.10.2.2.2.1">
                    <p id="section-toc.1-1.10.2.2.2.1.1"><a href="#section-10.2.1" class="xref">10.2.1</a>.  <a href="#name-welcoming-new-members" class="xref">Welcoming New Members</a><a href="#section-toc.1-1.10.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.10.2.3">
                <p id="section-toc.1-1.10.2.3.1"><a href="#section-10.3" class="xref">10.3</a>.  <a href="#name-ratchet-tree-extension" class="xref">Ratchet Tree Extension</a><a href="#section-toc.1-1.10.2.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="xref">11</a>. <a href="#name-extensibility" class="xref">Extensibility</a><a href="#section-toc.1-1.11.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="xref">12</a>. <a href="#name-sequencing-of-state-changes" class="xref">Sequencing of State Changes</a><a href="#section-toc.1-1.12.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-12.1" class="xref">12.1</a>.  <a href="#name-server-enforced-ordering" class="xref">Server-Enforced Ordering</a><a href="#section-toc.1-1.12.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#section-12.2" class="xref">12.2</a>.  <a href="#name-client-enforced-ordering" class="xref">Client-Enforced Ordering</a><a href="#section-toc.1-1.12.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="xref">13</a>. <a href="#name-application-messages" class="xref">Application Messages</a><a href="#section-toc.1-1.13.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#section-13.1" class="xref">13.1</a>.  <a href="#name-tree-of-application-secrets" class="xref">Tree of Application Secrets</a><a href="#section-toc.1-1.13.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.13.2.2">
                <p id="section-toc.1-1.13.2.2.1"><a href="#section-13.2" class="xref">13.2</a>.  <a href="#name-deletion-schedule" class="xref">Deletion Schedule</a><a href="#section-toc.1-1.13.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.13.2.3">
                <p id="section-toc.1-1.13.2.3.1"><a href="#section-13.3" class="xref">13.3</a>.  <a href="#name-further-restrictions" class="xref">Further Restrictions</a><a href="#section-toc.1-1.13.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.13.2.4">
                <p id="section-toc.1-1.13.2.4.1"><a href="#section-13.4" class="xref">13.4</a>.  <a href="#name-message-encryption-and-decr" class="xref">Message Encryption and Decryption</a><a href="#section-toc.1-1.13.2.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.13.2.5">
                <p id="section-toc.1-1.13.2.5.1"><a href="#section-13.5" class="xref">13.5</a>.  <a href="#name-delayed-and-reordered-appli" class="xref">Delayed and Reordered Application messages</a><a href="#section-toc.1-1.13.2.5.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-14" class="xref">14</a>. <a href="#name-security-considerations" class="xref">Security Considerations</a><a href="#section-toc.1-1.14.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.14.2.1">
                <p id="section-toc.1-1.14.2.1.1"><a href="#section-14.1" class="xref">14.1</a>.  <a href="#name-confidentiality-of-the-grou" class="xref">Confidentiality of the Group Secrets</a><a href="#section-toc.1-1.14.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.14.2.2">
                <p id="section-toc.1-1.14.2.2.1"><a href="#section-14.2" class="xref">14.2</a>.  <a href="#name-authentication" class="xref">Authentication</a><a href="#section-toc.1-1.14.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.14.2.3">
                <p id="section-toc.1-1.14.2.3.1"><a href="#section-14.3" class="xref">14.3</a>.  <a href="#name-forward-and-post-compromise" class="xref">Forward and post-compromise security</a><a href="#section-toc.1-1.14.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.14.2.4">
                <p id="section-toc.1-1.14.2.4.1"><a href="#section-14.4" class="xref">14.4</a>.  <a href="#name-initkey-reuse" class="xref">InitKey Reuse</a><a href="#section-toc.1-1.14.2.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.14.2.5">
                <p id="section-toc.1-1.14.2.5.1"><a href="#section-14.5" class="xref">14.5</a>.  <a href="#name-improving-randomness-of-sec" class="xref">Improving Randomness of Secrets</a><a href="#section-toc.1-1.14.2.5.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-15" class="xref">15</a>. <a href="#name-iana-considerations" class="xref">IANA Considerations</a><a href="#section-toc.1-1.15.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.15.2.1">
                <p id="section-toc.1-1.15.2.1.1"><a href="#section-15.1" class="xref">15.1</a>.  <a href="#name-mls-ciphersuites" class="xref">MLS Ciphersuites</a><a href="#section-toc.1-1.15.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.15.2.2">
                <p id="section-toc.1-1.15.2.2.1"><a href="#section-15.2" class="xref">15.2</a>.  <a href="#name-mls-extension-types" class="xref">MLS Extension Types</a><a href="#section-toc.1-1.15.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.15.2.3">
                <p id="section-toc.1-1.15.2.3.1"><a href="#section-15.3" class="xref">15.3</a>.  <a href="#name-mls-credential-types" class="xref">MLS Credential Types</a><a href="#section-toc.1-1.15.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.15.2.4">
                <p id="section-toc.1-1.15.2.4.1"><a href="#section-15.4" class="xref">15.4</a>.  <a href="#name-mls-designated-expert-pool" class="xref">MLS Designated Expert Pool</a><a href="#section-toc.1-1.15.2.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-16" class="xref">16</a>. <a href="#name-contributors" class="xref">Contributors</a><a href="#section-toc.1-1.16.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#section-17" class="xref">17</a>. <a href="#name-references" class="xref">References</a><a href="#section-toc.1-1.17.1" class="pilcrow">¶</a></p>
<ul class="compact ulEmpty toc">
<li class="compact ulEmpty toc" id="section-toc.1-1.17.2.1">
                <p id="section-toc.1-1.17.2.1.1"><a href="#section-17.1" class="xref">17.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a><a href="#section-toc.1-1.17.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="compact ulEmpty toc" id="section-toc.1-1.17.2.2">
                <p id="section-toc.1-1.17.2.2.1"><a href="#section-17.2" class="xref">17.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a><a href="#section-toc.1-1.17.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.18">
            <p id="section-toc.1-1.18.1"><a href="#section-appendix.a" class="xref">Appendix A</a>.  <a href="#name-tree-math" class="xref">Tree Math</a><a href="#section-toc.1-1.18.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact ulEmpty toc" id="section-toc.1-1.19">
            <p id="section-toc.1-1.19.1"><a href="#section-appendix.b" class="xref"></a><a href="#name-authors-addresses" class="xref">Authors' Addresses</a><a href="#section-toc.1-1.19.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">DISCLAIMER: This is a work-in-progress draft of MLS and has not yet
seen significant security analysis. It should not be used as a basis
for building production systems.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">RFC EDITOR: PLEASE REMOVE THE FOLLOWING PARAGRAPH The source for
this draft is maintained in GitHub. Suggested changes should be
submitted as pull requests at https://github.com/mlswg/mls-protocol.
Instructions are on that page as well. Editorial changes can be
managed in GitHub, but any substantive change should be discussed on
the MLS mailing list.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">A group of users who want to send each other encrypted messages needs
a way to derive shared symmetric encryption keys. For two parties,
this problem has been studied thoroughly, with the Double Ratchet
emerging as a common solution <span>[<a href="#doubleratchet" class="xref">doubleratchet</a>]</span> <span>[<a href="#signal" class="xref">signal</a>]</span>.
Channels implementing the Double Ratchet enjoy fine-grained forward secrecy
as well as post-compromise security, but are nonetheless efficient
enough for heavy use over low-bandwidth networks.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">For a group of size greater than two, a common strategy is to
unilaterally broadcast symmetric "sender" keys over existing shared
symmetric channels, and then for each member to send messages to the
group encrypted with their own sender key. Unfortunately, while this
improves efficiency over pairwise broadcast of individual messages and
provides forward secrecy (with the addition of a hash ratchet),
it is difficult to achieve post-compromise security with
sender keys. An adversary who learns a sender key can often indefinitely and
passively eavesdrop on that member's messages.  Generating and
distributing a new sender key provides a form of post-compromise
security with regard to that sender.  However, it requires
computation and communications resources that scale linearly with
the size of the group.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">In this document, we describe a protocol based on tree structures
that enable asynchronous group keying with forward secrecy and
post-compromise security.  Based on earlier work on "asynchronous
ratcheting trees" <span>[<a href="#art" class="xref">art</a>]</span>, the protocol presented here uses an
asynchronous key-encapsulation mechanism for tree structures.
This mechanism allows the members of the group to derive and update
shared keys with costs that scale as the log of the group size.<a href="#section-1-5" class="pilcrow">¶</a></p>
<div id="change-log">
<section id="section-1.1">
        <h3 id="name-change-log">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-change-log" class="section-name selfRef">Change Log</a>
        </h3>
<p id="section-1.1-1">RFC EDITOR PLEASE DELETE THIS SECTION.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">draft-10<a href="#section-1.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-3.1">Re-enable constant-time Add (*)<a href="#section-1.1-3.1" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-4">draft-09<a href="#section-1.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-5.1">Remove blanking of nodes on Add (*)<a href="#section-1.1-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.2">Change epoch numbers to uint64 (*)<a href="#section-1.1-5.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.3">Add PSK inputs (*)<a href="#section-1.1-5.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.4">Add key schedule exporter (*)<a href="#section-1.1-5.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.5">Sign the updated direct path on Commit, using "parent hashes" and one
signature per leaf (*)<a href="#section-1.1-5.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.6">Use structured types for external senders (*)<a href="#section-1.1-5.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.7">Redesign Welcome to include confirmation and use derived keys (*)<a href="#section-1.1-5.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.8">Remove ignored proposals (*)<a href="#section-1.1-5.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.9">Always include an Update with a Commit (*)<a href="#section-1.1-5.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.10">Add per-message entropy to guard against nonce reuse (*)<a href="#section-1.1-5.10" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.11">Use the same hash ratchet construct for both application and handshake keys (*)<a href="#section-1.1-5.11" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.12">Add more ciphersuites<a href="#section-1.1-5.12" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.13">Use HKDF to derive key pairs (*)<a href="#section-1.1-5.13" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.14">Mandate expiration of ClientInitKeys (*)<a href="#section-1.1-5.14" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.15">Add extensions to GroupContext and flesh out the extensibility story (*)<a href="#section-1.1-5.15" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.16">Rename ClientInitKey to KeyPackage<a href="#section-1.1-5.16" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-6">draft-08<a href="#section-1.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-7.1">Change ClientInitKeys so that they only refer to one ciphersuite (*)<a href="#section-1.1-7.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.2">Decompose group operations into Proposals and Commits (*)<a href="#section-1.1-7.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.3">Enable Add and Remove proposals from outside the group (*)<a href="#section-1.1-7.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.4">Replace Init messages with multi-recipient Welcome message (*)<a href="#section-1.1-7.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.5">Add extensions to ClientInitKeys for expiration and downgrade resistance (*)<a href="#section-1.1-7.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.6">Allow multiple Proposals and a single Commit in one MLSPlaintext (*)<a href="#section-1.1-7.6" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-8">draft-07<a href="#section-1.1-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-9.1">Initial version of the Tree based Application Key Schedule (*)<a href="#section-1.1-9.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.2">Initial definition of the Init message for group creation (*)<a href="#section-1.1-9.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.3">Fix issue with the transcript used for newcomers (*)<a href="#section-1.1-9.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.4">Clarifications on message framing and HPKE contexts (*)<a href="#section-1.1-9.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-10">draft-06<a href="#section-1.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-11.1">Reorder blanking and update in the Remove operation (*)<a href="#section-1.1-11.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.2">Rename the GroupState structure to GroupContext (*)<a href="#section-1.1-11.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.3">Rename UserInitKey to ClientInitKey<a href="#section-1.1-11.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.4">Resolve the circular dependency that draft-05 introduced in the
confirmation MAC calculation (*)<a href="#section-1.1-11.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.5">Cover the entire MLSPlaintext in the transcript hash (*)<a href="#section-1.1-11.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-12">draft-05<a href="#section-1.1-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-13.1">Common framing for handshake and application messages (*)<a href="#section-1.1-13.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.2">Handshake message encryption (*)<a href="#section-1.1-13.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.3">Convert from literal state to a commitment via the "tree hash" (*)<a href="#section-1.1-13.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.4">Add credentials to the tree and remove the "roster" concept (*)<a href="#section-1.1-13.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.5">Remove the secret field from tree node values<a href="#section-1.1-13.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-14">draft-04<a href="#section-1.1-14" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-15.1">Updating the language to be similar to the Architecture document<a href="#section-1.1-15.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-15.2">ECIES is now renamed in favor of HPKE (*)<a href="#section-1.1-15.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-15.3">Using a KDF instead of a Hash in TreeKEM (*)<a href="#section-1.1-15.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-16">draft-03<a href="#section-1.1-16" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-17.1">Added ciphersuites and signature schemes (*)<a href="#section-1.1-17.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-17.2">Re-ordered fields in UserInitKey to make parsing easier (*)<a href="#section-1.1-17.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-17.3">Fixed inconsistencies between Welcome and GroupState (*)<a href="#section-1.1-17.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-17.4">Added encryption of the Welcome message (*)<a href="#section-1.1-17.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-18">draft-02<a href="#section-1.1-18" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-19.1">Removed ART (*)<a href="#section-1.1-19.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-19.2">Allowed partial trees to avoid double-joins (*)<a href="#section-1.1-19.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-19.3">Added explicit key confirmation (*)<a href="#section-1.1-19.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-20">draft-01<a href="#section-1.1-20" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-21.1">Initial description of the Message Protection mechanism. (*)<a href="#section-1.1-21.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.2">Initial specification proposal for the Application Key Schedule
using the per-participant chaining of the Application Secret design. (*)<a href="#section-1.1-21.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.3">Initial specification proposal for an encryption mechanism to protect
Application Messages using an AEAD scheme. (*)<a href="#section-1.1-21.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.4">Initial specification proposal for an authentication mechanism
of Application Messages using signatures. (*)<a href="#section-1.1-21.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.5">Initial specification proposal for a padding mechanism to improving
protection of Application Messages against traffic analysis. (*)<a href="#section-1.1-21.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.6">Inversion of the Group Init Add and Application Secret derivations
in the Handshake Key Schedule to be ease chaining in case we switch
design. (*)<a href="#section-1.1-21.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.7">Removal of the UserAdd construct and split of GroupAdd into Add
and Welcome messages (*)<a href="#section-1.1-21.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.8">Initial proposal for authenticating handshake messages by signing
over group state and including group state in the key schedule (*)<a href="#section-1.1-21.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.9">Added an appendix with example code for tree math<a href="#section-1.1-21.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.10">Changed the ECIES mechanism used by TreeKEM so that it uses nonces
generated from the shared secret<a href="#section-1.1-21.10" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-22">draft-00<a href="#section-1.1-22" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-23.1">Initial adoption of draft-barnes-mls-protocol-01 as a WG item.<a href="#section-1.1-23.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="terminology">
<section id="section-2">
      <h2 id="name-terminology">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
      </h2>
<p id="section-2-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and
"OPTIONAL" in this document are to be interpreted as described in
BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span> when, and only when, they appear in all
capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2-2">
        <dt id="section-2-2.1">Client:</dt>
        <dd style="margin-left: 1.5em" id="section-2-2.2">
  An agent that uses this protocol to establish shared cryptographic
state with other clients.  A client is defined by the
cryptographic keys it holds.<a href="#section-2-2.2" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.3">Group:</dt>
        <dd style="margin-left: 1.5em" id="section-2-2.4">
  A collection of clients with shared cryptographic state.<a href="#section-2-2.4" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.5">Member:</dt>
        <dd style="margin-left: 1.5em" id="section-2-2.6">
  A client that is included in the shared state of a group, hence
has access to the group's secrets.<a href="#section-2-2.6" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.7">Key Package:</dt>
        <dd style="margin-left: 1.5em" id="section-2-2.8">
  A signed object describing a client's identity and capabilities, and including
a hybrid public-key encryption (HPKE <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span> ) public key that
can be used to encrypt to that client.<a href="#section-2-2.8" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.9">Initialization Key (InitKey):</dt>
        <dd style="margin-left: 1.5em" id="section-2-2.10">
  A key package that is prepublished by a client, which other clients can use to
introduce the client to a new group.<a href="#section-2-2.10" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.11">Identity Key:</dt>
        <dd style="margin-left: 1.5em" id="section-2-2.12">
  A long-lived signing key pair used to authenticate the sender of a
message.<a href="#section-2-2.12" class="pilcrow">¶</a>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-2-3">Terminology specific to tree computations is described in
<a href="#ratchet-trees" class="xref">Section 5</a>.<a href="#section-2-3" class="pilcrow">¶</a></p>
<p id="section-2-4">We use the TLS presentation language <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span> to
describe the structure of protocol messages.<a href="#section-2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="basic-assumptions">
<section id="section-3">
      <h2 id="name-basic-assumptions">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-basic-assumptions" class="section-name selfRef">Basic Assumptions</a>
      </h2>
<p id="section-3-1">This protocol is designed to execute in the context of a Service Provider (SP)
as described in <span>[<a href="#I-D.ietf-mls-architecture" class="xref">I-D.ietf-mls-architecture</a>]</span>.  In particular, we assume
the SP provides the following services:<a href="#section-3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.1">A long-term identity key provider which allows clients to authenticate
protocol messages in a group.<a href="#section-3-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-3-2.2">A broadcast channel, for each group, which will relay a message to all members
of a group.  For the most part, we assume that this channel delivers messages
in the same order to all participants.  (See <a href="#sequencing" class="xref">Section 12</a> for further
considerations.)<a href="#section-3-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-3-2.3">A directory to which clients can publish key packages and download
key packages for other participants.<a href="#section-3-2.3" class="pilcrow">¶</a>
</li>
      </ul>
</section>
</div>
<div id="protocol-overview">
<section id="section-4">
      <h2 id="name-protocol-overview">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-protocol-overview" class="section-name selfRef">Protocol Overview</a>
      </h2>
<p id="section-4-1">The goal of this protocol is to allow a group of clients to exchange
confidential and authenticated messages. It does so by deriving a sequence
of secrets and keys known only to members. Those should be secret against an
active network adversary and should have both forward secrecy and
post-compromise security with respect to compromise of any members.<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">We describe the information stored by each client as <em>state</em>, which includes
both public and private data. An initial state is set up by a group creator,
which is a group containing only itself. The creator then sends <em>Add</em>
proposals for each client in the initial set of members, followed by a <em>Commit</em>
message which incorporates all of the <em>Adds</em> into the group state. Finally, the
group creator generates a <em>Welcome</em> message corresponding to the Commit and
sends this directly to all the new members, who can use the information
it contains to set up their own group state and derive a shared
secret. Members exchange Commit messages for post-compromise security, to add new
members, and to remove existing members. These messages produce new shared
secrets which are causally linked to their predecessors, forming a logical
Directed Acyclic Graph (DAG) of states.<a href="#section-4-2" class="pilcrow">¶</a></p>
<p id="section-4-3">The protocol algorithms we specify here follow. Each algorithm specifies
both (i) how a client performs the operation and (ii) how other clients
update their state based on it.<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">There are three major operations in the lifecycle of a group:<a href="#section-4-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4-5.1">Adding a member, initiated by a current member;<a href="#section-4-5.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-5.2">Updating the leaf secret of a member;<a href="#section-4-5.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-5.3">Removing a member.<a href="#section-4-5.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-4-6">Each of these operations is "proposed" by sending a message of the corresponding
type (Add / Update / Remove).  The state of the group is not changed, however,
until a Commit message is sent to provide the group with fresh entropy.  In this
section, we show each proposal being committed immediately, but in more advanced
deployment cases an application might gather several proposals before
committing them all at once.<a href="#section-4-6" class="pilcrow">¶</a></p>
<p id="section-4-7">Before the initialization of a group, clients publish InitKeys (as KeyPackage
objects) to a directory provided by the Service Provider.<a href="#section-4-7" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-8">
<pre>
                                                               Group
A                B                C            Directory       Channel
|                |                |                |              |
| KeyPackageA    |                |                |              |
|-------------------------------------------------&gt;|              |
|                |                |                |              |
|                | KeyPackageB    |                |              |
|                |--------------------------------&gt;|              |
|                |                |                |              |
|                |                | KeyPackageC    |              |
|                |                |---------------&gt;|              |
|                |                |                |              |
</pre><a href="#section-4-8" class="pilcrow">¶</a>
</div>
<p id="section-4-9">When a client A wants to establish a group with B and C, it first initializes a
group state containing only itself and downloads KeyPackages for B and C. For
each member, A generates an Add and Commit message adding that member, and
broadcasts them to the group. It also generates a Welcome message and sends this
directly to the new member (there's no need to send it to the group). Only after
A has received its Commit message back from the server does it update its state
to reflect the new member's addition.<a href="#section-4-9" class="pilcrow">¶</a></p>
<p id="section-4-10">Upon receiving the Welcome message and the corresponding Commit, the new member
will be able to read and send new messages to the group. Messages received
before the client has joined the group are ignored.<a href="#section-4-10" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-11">
<pre>
                                                               Group
A              B              C          Directory            Channel
|              |              |              |                   |
|         KeyPackageB, KeyPackageC           |                   |
|&lt;-------------------------------------------|                   |
|state.init()  |              |              |                   |
|              |              |              |                   |
|              |              |              | Add(A-&gt;AB)        |
|              |              |              | Commit(Add)       |
|---------------------------------------------------------------&gt;|
|              |              |              |                   |
|  Welcome(B)  |              |              |                   |
|-------------&gt;|state.init()  |              |                   |
|              |              |              |                   |
|              |              |              | Add(A-&gt;AB)        |
|              |              |              | Commit(Add)       |
|&lt;---------------------------------------------------------------|
|state.add(B)  |&lt;------------------------------------------------|
|              |state.join()  |              |                   |
|              |              |              |                   |
|              |              |              | Add(AB-&gt;ABC)      |
|              |              |              | Commit(Add)       |
|---------------------------------------------------------------&gt;|
|              |              |              |                   |
|              |  Welcome(C)  |              |                   |
|----------------------------&gt;|state.init()  |                   |
|              |              |              |                   |
|              |              |              | Add(AB-&gt;ABC)      |
|              |              |              | Commit(Add)       |
|&lt;---------------------------------------------------------------|
|state.add(C)  |&lt;------------------------------------------------|
|              |state.add(C)  |&lt;---------------------------------|
|              |              |state.join()  |                   |
</pre><a href="#section-4-11" class="pilcrow">¶</a>
</div>
<p id="section-4-12">Subsequent additions of group members proceed in the same way.  Any
member of the group can download a KeyPackage for a new client
and broadcast an Add message that the current group can use to update
their state, and a Welcome message that the new client can use to
initialize its state.<a href="#section-4-12" class="pilcrow">¶</a></p>
<p id="section-4-13">To enforce the forward secrecy and post-compromise security of messages,
each member periodically updates their leaf secret.
Any member can update this information at any time by generating a fresh
KeyPackage and sending an Update message followed by a Commit message.
Once all members have processed both, the group's secrets will be unknown to an
attacker that had compromised the sender's prior leaf secret.<a href="#section-4-13" class="pilcrow">¶</a></p>
<p id="section-4-14">Update messages should be sent at regular intervals of time as long as the group
is active, and members that don't update should eventually be removed from the
group. It's left to the application to determine an appropriate amount of time
between Updates.<a href="#section-4-14" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-15">
<pre>
                                                          Group
A              B     ...      Z          Directory        Channel
|              |              |              |              |
|              | Update(B)    |              |              |
|              |-------------------------------------------&gt;|
| Commit(Upd)  |              |              |              |
|----------------------------------------------------------&gt;|
|              |              |              |              |
|              |              |              | Update(B)    |
|              |              |              | Commit(Upd)  |
|&lt;----------------------------------------------------------|
|state.upd(B)  |&lt;-------------------------------------------|
|              |state.upd(B)  |&lt;----------------------------|
|              |              |state.upd(B)  |              |
|              |              |              |              |
</pre><a href="#section-4-15" class="pilcrow">¶</a>
</div>
<p id="section-4-16">Members are removed from the group in a similar way.
Any member of the group can send a Remove proposal followed by a
Commit message, which adds new entropy to the group state
that's known to all except the removed member.
Note that this does not necessarily imply that any member
is actually allowed to evict other members; groups can
enforce access control policies on top of these
basic mechanism.<a href="#section-4-16" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-17">
<pre>
                                                          Group
A              B     ...      Z          Directory       Channel
|              |              |              |              |
|              |              | Remove(B)    |              |
|              |              | Commit(Rem)  |              |
|              |              |----------------------------&gt;|
|              |              |              |              |
|              |              |              | Remove(B)    |
|              |              |              | Commit(Rem)  |
|&lt;----------------------------------------------------------|
|state.rem(B)  |              |&lt;----------------------------|
|              |              |state.rem(B)  |              |
|              |              |              |              |
|              |              |              |              |
</pre><a href="#section-4-17" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="ratchet-trees">
<section id="section-5">
      <h2 id="name-ratchet-trees">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-ratchet-trees" class="section-name selfRef">Ratchet Trees</a>
      </h2>
<p id="section-5-1">The protocol uses "ratchet trees" for deriving shared secrets among
a group of clients.<a href="#section-5-1" class="pilcrow">¶</a></p>
<div id="tree-computation-terminology">
<section id="section-5.1">
        <h3 id="name-tree-computation-terminolog">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-tree-computation-terminolog" class="section-name selfRef">Tree Computation Terminology</a>
        </h3>
<p id="section-5.1-1">Trees consist of <em>nodes</em>. A node is a
<em>leaf</em> if it has no children, and a <em>parent</em> otherwise; note that all
parents in our trees have precisely
two children, a <em>left</em> child and a <em>right</em> child. A node is the <em>root</em>
of a tree if it has no parents, and <em>intermediate</em> if it has both
children and parents. The <em>descendants</em> of a node are that node, its
children, and the descendants of its children, and we say a tree
<em>contains</em> a node if that node is a descendant of the root of the
tree. Nodes are <em>siblings</em> if they share the same parent.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1-2">A <em>subtree</em> of a tree is the tree given by the descendants of any
node, the <em>head</em> of the subtree. The <em>size</em> of a tree or subtree is the
number of leaf nodes it contains.  For a given parent node, its <em>left
subtree</em> is the subtree with its left child as head (respectively
<em>right subtree</em>).<a href="#section-5.1-2" class="pilcrow">¶</a></p>
<p id="section-5.1-3">All trees used in this protocol are left-balanced binary trees. A
binary tree is <em>full</em> (and <em>balanced</em>) if its size is a power of
two and for any parent node in the tree, its left and right subtrees
have the same size.<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<p id="section-5.1-4">A binary tree is <em>left-balanced</em> if for every
parent, either the parent is balanced, or the left subtree of that
parent is the largest full subtree that could be constructed from
the leaves present in the parent's own subtree.
Given a list of <code>n</code> items, there is a unique left-balanced
binary tree structure with these elements as leaves.<a href="#section-5.1-4" class="pilcrow">¶</a></p>
<p id="section-5.1-5">(Note that left-balanced binary trees are the same structure that is
used for the Merkle trees in the Certificate Transparency protocol
<span>[<a href="#I-D.ietf-trans-rfc6962-bis" class="xref">I-D.ietf-trans-rfc6962-bis</a>]</span>.)<a href="#section-5.1-5" class="pilcrow">¶</a></p>
<p id="section-5.1-6">The <em>direct path</em> of a root is the empty list, and of any other node
is the concatenation of that node's parent along with the parent's direct path.
The <em>copath</em> of a node is the node's sibling concatenated with the list of
siblings of all the nodes in its direct path, excluding the root.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<p id="section-5.1-7">For example, in the below tree:<a href="#section-5.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.1-8.1">The direct path of C is (CD, ABCD, ABCDEFG)<a href="#section-5.1-8.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-8.2">The copath of C is (D, AB, EFG)<a href="#section-5.1-8.2" class="pilcrow">¶</a>
</li>
        </ul>
<div class="artwork art-text alignLeft" id="section-5.1-9">
<pre>
            ABCDEFG
           /      \
          /        \
         /          \
     ABCD            EFG
    /    \          /  \
   /      \        /    \
  AB      CD      EF    |
 / \     / \     / \    |
A   B   C   D   E   F   G

                    1 1 1
0 1 2 3 4 5 6 7 8 9 0 1 2
</pre><a href="#section-5.1-9" class="pilcrow">¶</a>
</div>
<p id="section-5.1-10">Each node in the tree is assigned a <em>node index</em>, starting at zero and
running from left to right.  A node is a leaf node if and only if it
has an even index.  The node indices for the nodes in the above tree
are as follows:<a href="#section-5.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.1-11.1">0 = A<a href="#section-5.1-11.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.2">1 = AB<a href="#section-5.1-11.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.3">2 = B<a href="#section-5.1-11.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.4">3 = ABCD<a href="#section-5.1-11.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.5">4 = C<a href="#section-5.1-11.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.6">5 = CD<a href="#section-5.1-11.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.7">6 = D<a href="#section-5.1-11.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.8">7 = ABCDEFG<a href="#section-5.1-11.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.9">8 = E<a href="#section-5.1-11.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.10">9 = EF<a href="#section-5.1-11.10" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.11">10 = F<a href="#section-5.1-11.11" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.12">11 = EFG<a href="#section-5.1-11.12" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-11.13">12 = G<a href="#section-5.1-11.13" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.1-12">The leaves of the tree are indexed separately, using a <em>leaf index</em>,
since the protocol messages only need to refer to leaves in the
tree.  Like nodes, leaves are numbered left to right.  The node with
leaf index <code>k</code> is also called the <code>k-th</code> leaf.  Note that
given the above numbering, a node is a leaf node if and only if it
has an even node index, and a leaf node's leaf index is half its
node index.  The leaf indices in the above tree are as follows:<a href="#section-5.1-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.1-13.1">0 = A<a href="#section-5.1-13.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-13.2">1 = B<a href="#section-5.1-13.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-13.3">2 = C<a href="#section-5.1-13.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-13.4">3 = D<a href="#section-5.1-13.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-13.5">4 = E<a href="#section-5.1-13.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-13.6">5 = F<a href="#section-5.1-13.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-13.7">6 = G<a href="#section-5.1-13.7" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="ratchet-tree-nodes">
<section id="section-5.2">
        <h3 id="name-ratchet-tree-nodes">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-ratchet-tree-nodes" class="section-name selfRef">Ratchet Tree Nodes</a>
        </h3>
<p id="section-5.2-1">A particular instance of a ratchet tree is defined by the same parameters that
define an instance of HPKE, namely:<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-2.1">A Key Encapsulation Mechanism (KEM), including a <code>DeriveKeyPair</code> function that
creates a key pair for the KEM from a symmetric secret<a href="#section-5.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-2.2">A Key Derivation Function (KDF), including <code>Extract</code> and <code>Expand</code> functions<a href="#section-5.2-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-2.3">An AEAD encryption scheme<a href="#section-5.2-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.2-3">Each node in a ratchet tree contains up to five values:<a href="#section-5.2-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-4.1">A private key (only within the member's direct path, see below)<a href="#section-5.2-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-4.2">A public key<a href="#section-5.2-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-4.3">An ordered list of leaf indices for "unmerged" leaves (see
<a href="#views" class="xref">Section 5.3</a>)<a href="#section-5.2-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-4.4">A credential (only for leaf nodes)<a href="#section-5.2-4.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-4.5">A hash of the node's parent, as of the last time the node was changed.<a href="#section-5.2-4.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.2-5">The conditions under which each of these values must or must not be
present are laid out in <a href="#views" class="xref">Section 5.3</a>.<a href="#section-5.2-5" class="pilcrow">¶</a></p>
<p id="section-5.2-6">A node in the tree may also be <em>blank</em>, indicating that no value is
present at that node.  The <em>resolution</em> of a node is an ordered list
of non-blank nodes that collectively cover all non-blank descendants
of the node.<a href="#section-5.2-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-7.1">The resolution of a non-blank node comprises the node itself,
followed by its list of unmerged leaves, if any<a href="#section-5.2-7.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-7.2">The resolution of a blank leaf node is the empty list<a href="#section-5.2-7.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-7.3">The resolution of a blank intermediate node is the result of
concatenating the resolution of its left child with the resolution
of its right child, in that order<a href="#section-5.2-7.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.2-8">For example, consider the following tree, where the "_" character
represents a blank node:<a href="#section-5.2-8" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.2-9">
<pre>
      _
    /   \
   /     \
  _       CD[C]
 / \     / \
A   _   C   D

0 1 2 3 4 5 6
</pre><a href="#section-5.2-9" class="pilcrow">¶</a>
</div>
<p id="section-5.2-10">In this tree, we can see all of the above rules in play:<a href="#section-5.2-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-11.1">The resolution of node 5 is the list [CD, C]<a href="#section-5.2-11.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-11.2">The resolution of node 2 is the empty list []<a href="#section-5.2-11.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.2-11.3">The resolution of node 3 is the list [A, CD, C]<a href="#section-5.2-11.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.2-12">Every node, regardless of whether the node is blank or populated, has
a corresponding <em>hash</em> that summarizes the contents of the subtree
below that node.  The rules for computing these hashes are described
in <a href="#tree-hashes" class="xref">Section 7.5</a>.<a href="#section-5.2-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="views">
<section id="section-5.3">
        <h3 id="name-views-of-a-ratchet-tree">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-views-of-a-ratchet-tree" class="section-name selfRef">Views of a Ratchet Tree</a>
        </h3>
<p id="section-5.3-1">We generally assume that each participant maintains a complete and
up-to-date view of the public state of the group's ratchet tree,
including the public keys for all nodes and the credentials
associated with the leaf nodes.<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<p id="section-5.3-2">No participant in an MLS group knows the private key associated with
every node in the tree. Instead, each member is assigned to a leaf of the tree,
which determines the subset of private keys it knows. The
credential stored at that leaf is one provided by the member.<a href="#section-5.3-2" class="pilcrow">¶</a></p>
<p id="section-5.3-3">In particular, MLS maintains the members' views of the tree in such
a way as to maintain the <em>tree invariant</em>:<a href="#section-5.3-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.3-4">
<pre>
The private key for a node in the tree is known to a member of
the group only if that member's leaf is a descendant of
the node.
</pre><a href="#section-5.3-4" class="pilcrow">¶</a>
</div>
<p id="section-5.3-5">In other words, if a node is not blank, then it holds a public key.
The corresponding private key is known only to members occupying
leaves below that node.<a href="#section-5.3-5" class="pilcrow">¶</a></p>
<p id="section-5.3-6">The reverse implication is not true: A member may not know the private keys of
all the intermediate nodes they're below.  Such a member has an <em>unmerged</em> leaf.
Encrypting to an intermediate node requires encrypting to the node's public key,
as well as the public keys of all the unmerged leaves below it.  A leaf is
unmerged when it is first added, because the process of adding the leaf does not
give it access to all of the nodes above it in the tree.  Leaves are "merged" as
they receive the private keys for nodes, as described in
<a href="#ratchet-tree-evolution" class="xref">Section 5.4</a>.<a href="#section-5.3-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ratchet-tree-evolution">
<section id="section-5.4">
        <h3 id="name-ratchet-tree-evolution">
<a href="#section-5.4" class="section-number selfRef">5.4. </a><a href="#name-ratchet-tree-evolution" class="section-name selfRef">Ratchet Tree Evolution</a>
        </h3>
<p id="section-5.4-1">A member of an MLS group advances the key schedule to provide forward secrecy
and post-compromise security by providing the group with fresh key material to
be added into the group's shared secret.
To do so, one member of the group generates fresh key
material, applies it to their local tree state, and then sends this key material
to other members in the group via an UpdatePath message (see <a href="#update-paths" class="xref">Section 7.7</a>) .
All other group members then apply the key material in the UpdatePath to their
own local tree state to derive the group's now-updated shared secret.<a href="#section-5.4-1" class="pilcrow">¶</a></p>
<p id="section-5.4-2">To begin, the generator of the UpdatePath updates its leaf
KeyPackage and its direct path to the root with new secret values.  The
HPKE leaf public key within the KeyPackage MUST be derived from a freshly
generated HPKE secret key to provide post-compromise security.<a href="#section-5.4-2" class="pilcrow">¶</a></p>
<p id="section-5.4-3">The generator of the UpdatePath starts by sampling a fresh random value called
"leaf_secret", and uses the leaf_secret to generate their leaf HPKE key pair
(see <a href="#key-packages" class="xref">Section 7</a>) and to seed a sequence of "path secrets", one for each
ancestor of its leaf. In this setting,
path_secret[0] refers to the node directly above the leaf,
path_secret[1] for its parent, and so on. At each step, the path
secret is used to derive a new secret value for the corresponding
node, from which the node's key pair is derived.<a href="#section-5.4-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.4-4">
<pre>
leaf_node_secret = DeriveSecret(leaf_secret, "node")
path_secret[0] = DeriveSecret(leaf_secret, "path")

path_secret[n] = DeriveSecret(path_secret[n-1], "path")
node_secret[n] = DeriveSecret(path_secret[n], "node")

leaf_priv, leaf_pub = KEM.DeriveKeyPair(leaf_node_secret)
node_priv[n], node_pub[n] = KEM.DeriveKeyPair(node_secret[n])
</pre><a href="#section-5.4-4" class="pilcrow">¶</a>
</div>
<p id="section-5.4-5">For example, suppose there is a group with four members:<a href="#section-5.4-5" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.4-6">
<pre>
      G
     / \
    /   \
   /     \
  E       _
 / \     / \
A   B   C   D
</pre><a href="#section-5.4-6" class="pilcrow">¶</a>
</div>
<p id="section-5.4-7">If member B subsequently generates an UpdatePath based on a secret
"leaf_secret", then it would generate the following sequence
of path secrets:<a href="#section-5.4-7" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.4-8">
<pre>
path_secret[1] --&gt; node_secret[1] --&gt; node_priv[1], node_pub[1]
     ^
     |
path_secret[0] --&gt; node_secret[0] --&gt; node_priv[0], node_pub[0]
     ^
     |
leaf_secret    --&gt; leaf_node_secret --&gt; leaf_priv, leaf_pub
                                     ~&gt; leaf_key_package
</pre><a href="#section-5.4-8" class="pilcrow">¶</a>
</div>
<p id="section-5.4-9">After applying the UpdatePath, the tree will have the following structure, where
"np[i]" represents the node_priv values generated as described
above:<a href="#section-5.4-9" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.4-10">
<pre>
          np[1]
         /     \
     np[0]      _
     /  \      / \
    A    B    C   D
</pre><a href="#section-5.4-10" class="pilcrow">¶</a>
</div>
<p id="section-5.4-11">After performing these operations, the generator of the UpdatePath MUST
delete the leaf_secret.<a href="#section-5.4-11" class="pilcrow">¶</a></p>
</section>
</div>
<div id="synchronizing-views-of-the-tree">
<section id="section-5.5">
        <h3 id="name-synchronizing-views-of-the-">
<a href="#section-5.5" class="section-number selfRef">5.5. </a><a href="#name-synchronizing-views-of-the-" class="section-name selfRef">Synchronizing Views of the Tree</a>
        </h3>
<p id="section-5.5-1">After generating fresh key material and applying it to ratchet forward their
local tree state as described in the prior section, the generator must broadcast
this update to other members of the group in a Commit message, who
apply it to keep their local views of the tree in
sync with the sender's.  More specifically, when a member commits a change to
the tree (e.g., to add or remove a member), it transmits a UpdatePath message
containing a set of public and encrypted private
values for intermediate nodes in the direct path of a leaf. The
other members of the group use these values to update
their view of the tree, aligning their copy of the tree to the
sender's.<a href="#section-5.5-1" class="pilcrow">¶</a></p>
<p id="section-5.5-2">To transmit this update, the sender broadcasts to the group
the following information for each node in the direct path of the
leaf, including the root:<a href="#section-5.5-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.5-3.1">The public key for the node<a href="#section-5.5-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.5-3.2">Zero or more encrypted copies of the path secret corresponding to
the node<a href="#section-5.5-3.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.5-4">The path secret value for a given node is encrypted for the subtree
corresponding to the parent's non-updated child, that is, the child
on the copath of the leaf node.
There is one encrypted path secret for each public key in the resolution
of the non-updated child.<a href="#section-5.5-4" class="pilcrow">¶</a></p>
<p id="section-5.5-5">The recipient of a path update processes it with the following steps:<a href="#section-5.5-5" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.5-6">
<li id="section-5.5-6.1">
            <p id="section-5.5-6.1.1">Compute the updated path secrets.<a href="#section-5.5-6.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.5-6.1.2.1">Identify a node in the direct path for which the local member
is in the subtree of the non-updated child.<a href="#section-5.5-6.1.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-5.5-6.1.2.2">Identify a node in the resolution of the copath node for
which this node has a private key.<a href="#section-5.5-6.1.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-5.5-6.1.2.3">Decrypt the path secret for the parent of the copath node using
the private key from the resolution node.<a href="#section-5.5-6.1.2.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-5.5-6.1.2.4">Derive path secrets for ancestors of that node using the
algorithm described above.<a href="#section-5.5-6.1.2.4" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-5.5-6.1.2.5">The recipient SHOULD verify that the received public keys agree
with the public keys derived from the new path_secret values.<a href="#section-5.5-6.1.2.5" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li id="section-5.5-6.2">
            <p id="section-5.5-6.2.1">Merge the updated path secrets into the tree.<a href="#section-5.5-6.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.5-6.2.2.1">
                <p id="section-5.5-6.2.2.1.1">For all updated nodes,<a href="#section-5.5-6.2.2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.5-6.2.2.1.2.1">Replace the public key for each node with the received public key.<a href="#section-5.5-6.2.2.1.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-5.5-6.2.2.1.2.2">Set the list of unmerged leaves to the empty list.<a href="#section-5.5-6.2.2.1.2.2" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-5.5-6.2.2.1.2.3">Store the updated hash of the node's parent (represented as a ParentNode
struct), going from root to leaf, so that each hash incorporates all the
nodes above it. The root node always has a zero-length hash for this
value.<a href="#section-5.5-6.2.2.1.2.3" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-5.5-6.2.2.2">For nodes where an updated path secret was computed in step 1,
compute the corresponding node key pair and replace the values
stored at the node with the computed values.<a href="#section-5.5-6.2.2.2" class="pilcrow">¶</a>
</li>
            </ul>
</li>
        </ol>
<p id="section-5.5-7">For example, in order to communicate the example update described in
the previous section, the sender would transmit the following
values:<a href="#section-5.5-7" class="pilcrow">¶</a></p>
<table class="center" id="table-1">
          <caption><a href="#table-1" class="selfRef">Table 1</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Public Key</th>
              <th class="text-left" rowspan="1" colspan="1">Ciphertext(s)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">pk(ns[1])</td>
              <td class="text-left" rowspan="1" colspan="1">E(pk(C), ps[1]), E(pk(D), ps[1])</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">pk(ns[0])</td>
              <td class="text-left" rowspan="1" colspan="1">E(pk(A), ps[0])</td>
            </tr>
          </tbody>
        </table>
<p id="section-5.5-9">In this table, the value pk(ns[X]) represents the public key
derived from the node secret X, whereas pk(X) represents the public leaf key
for user X.  The value E(K, S) represents
the public-key encryption of the path secret S to the
public key K.<a href="#section-5.5-9" class="pilcrow">¶</a></p>
<p id="section-5.5-10">After processing the update, each recipient MUST delete outdated key material,
specifically:<a href="#section-5.5-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.5-11.1">The path secrets used to derive each updated node key pair.<a href="#section-5.5-11.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.5-11.2">Each outdated node key pair that was replaced by the update.<a href="#section-5.5-11.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="cryptographic-objects">
<section id="section-6">
      <h2 id="name-cryptographic-objects">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-cryptographic-objects" class="section-name selfRef">Cryptographic Objects</a>
      </h2>
<div id="ciphersuites">
<section id="section-6.1">
        <h3 id="name-ciphersuites">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-ciphersuites" class="section-name selfRef">Ciphersuites</a>
        </h3>
<p id="section-6.1-1">Each MLS session uses a single ciphersuite that specifies the
following primitives to be used in group key computations:<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1-2.1">
            <p id="section-6.1-2.1.1">HPKE parameters:<a href="#section-6.1-2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1-2.1.2.1">A Key Encapsulation Mechanism (KEM)<a href="#section-6.1-2.1.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-6.1-2.1.2.2">A Key Derivation Function (KDF)<a href="#section-6.1-2.1.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-6.1-2.1.2.3">An AEAD encryption algorithm<a href="#section-6.1-2.1.2.3" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-6.1-2.2">A hash algorithm<a href="#section-6.1-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.1-2.3">A signature algorithm<a href="#section-6.1-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-6.1-3">The HPKE parameters are used to instantiate HPKE <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span> for the
purpose of public-key encryption.  The <code>DeriveKeyPair</code> function associated to
the KEM for the ciphersuite maps octet strings to HPKE key pairs.<a href="#section-6.1-3" class="pilcrow">¶</a></p>
<p id="section-6.1-4">Ciphersuites are represented with the CipherSuite type. HPKE public keys
are opaque values in a format defined by the underlying
protocol (see the Cryptographic Dependencies section of the HPKE specification for more
information).<a href="#section-6.1-4" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-6.1-5">
<pre>
opaque HPKEPublicKey&lt;1..2^16-1&gt;;
</pre><a href="#section-6.1-5" class="pilcrow">¶</a>
</div>
<p id="section-6.1-6">The signature algorithm specified in the ciphersuite is the mandatory algorithm
to be used for signatures in MLSPlaintext and the tree signatures.  It MUST be
the same as the signature algorithm specified in the credential field of the
KeyPackage objects in the leaves of the tree (including the InitKeys
used to add new members).<a href="#section-6.1-6" class="pilcrow">¶</a></p>
<p id="section-6.1-7">The ciphersuites are defined in section <a href="#mls-ciphersuites" class="xref">Section 15.1</a>.<a href="#section-6.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="credentials">
<section id="section-6.2">
        <h3 id="name-credentials">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-credentials" class="section-name selfRef">Credentials</a>
        </h3>
<p id="section-6.2-1">A member of a group authenticates the identities of other
participants by means of credentials issued by some authentication
system, like a PKI.  Each type of credential MUST express the
following data:<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.2-2.1">The public key of a signature key pair<a href="#section-6.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.2-2.2">The identity of the holder of the private key<a href="#section-6.2-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.2-2.3">The signature scheme that the holder will use to sign MLS messages<a href="#section-6.2-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-6.2-3">Credentials MAY also include information that allows a relying party
to verify the identity / signing key binding.<a href="#section-6.2-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-6.2-4">
<pre>
// See IANA registry for registered values
uint16 CredentialType;

struct {
    opaque identity&lt;0..2^16-1&gt;;
    opaque public_key&lt;0..2^16-1&gt;;
} BasicCredential;

struct {
    CredentialType credential_type;
    select (Credential.credential_type) {
        case basic:
            BasicCredential;

        case x509:
            opaque cert_data&lt;1..2^24-1&gt;;
    };
} Credential;
</pre><a href="#section-6.2-4" class="pilcrow">¶</a>
</div>
<p id="section-6.2-5">A BasicCredential is a raw, unauthenticated assertion of an identity/key
binding.  The format of the key in the <code>public_key</code> field is defined by the
relevant ciphersuite: the group ciphersuite for a credential in a ratchet tree,
the KeyPackage ciphersuite for a credential in a KeyPackage object.<a href="#section-6.2-5" class="pilcrow">¶</a></p>
<p id="section-6.2-6">For ciphersuites using Ed25519 or Ed448 signature schemes, the public key is in
the format specified <span>[<a href="#RFC8032" class="xref">RFC8032</a>]</span>.  For ciphersuites using ECDSA with the NIST
curves P-256 or P-521, the public key is the output of the uncompressed
Elliptic-Curve-Point-to-Octet-String conversion according to <span>[<a href="#SECG" class="xref">SECG</a>]</span>.<a href="#section-6.2-6" class="pilcrow">¶</a></p>
<p id="section-6.2-7">Note that each new credential that has not already been validated
by the application MUST be validated against the Authentication
Service.<a href="#section-6.2-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="key-packages">
<section id="section-7">
      <h2 id="name-key-packages">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-key-packages" class="section-name selfRef">Key Packages</a>
      </h2>
<p id="section-7-1">In order to facilitate asynchronous addition of clients to a
group, it is possible to pre-publish key packages that
provide some public information about a user. KeyPackage
structures provide information about a client that any existing
member can use to add this client to the group asynchronously.<a href="#section-7-1" class="pilcrow">¶</a></p>
<p id="section-7-2">A KeyPackage object specifies a ciphersuite that the client
supports, as well as providing a public key that others can use
for key agreement. The client's identity key can be updated
throughout the lifetime of the group by sending a new KeyPackage
with a new identity; the new identity MUST be validated by the
authentication service.<a href="#section-7-2" class="pilcrow">¶</a></p>
<p id="section-7-3">When used as InitKeys, KeyPackages are intended to be used only once and SHOULD NOT
be reused except in case of last resort. (See <a href="#initkey-reuse" class="xref">Section 14.4</a>).
Clients MAY generate and publish multiple InitKeys to
support multiple ciphersuites.<a href="#section-7-3" class="pilcrow">¶</a></p>
<p id="section-7-4">KeyPackages contain a public key chosen by the client, which the
client MUST ensure uniquely identifies a given KeyPackage object
among the set of KeyPackages created by this client.<a href="#section-7-4" class="pilcrow">¶</a></p>
<p id="section-7-5">The value for hpke_init_key MUST be a public key for the asymmetric
encryption scheme defined by cipher_suite. The whole structure
is signed using the client's identity key. A KeyPackage object
with an invalid signature field MUST be considered malformed.
The input to the signature computation comprises all of the fields
except for the signature field.<a href="#section-7-5" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7-6">
<pre>
enum {
    reserved(0),
    mls10(1),
    (255)
} ProtocolVersion;

// See IANA registry for registered values
uint16 ExtensionType;

struct {
    ExtensionType extension_type;
    opaque extension_data&lt;0..2^16-1&gt;;
} Extension;

struct {
    ProtocolVersion version;
    CipherSuite cipher_suite;
    HPKEPublicKey hpke_init_key;
    Credential credential;
    Extension extensions&lt;8..2^32-1&gt;;
    opaque signature&lt;0..2^16-1&gt;;
} KeyPackage;
</pre><a href="#section-7-6" class="pilcrow">¶</a>
</div>
<p id="section-7-7">KeyPackage objects MUST contain at least two extensions, one of type
<code>capabilities</code>, and one of
type <code>lifetime</code>.  The <code>capabilities</code> extension
allow MLS session establishment to be safe from downgrade attacks on the
parameters described (as discussed in <a href="#group-creation" class="xref">Section 9</a>), while still only advertising
one version / ciphersuite per KeyPackage.<a href="#section-7-7" class="pilcrow">¶</a></p>
<p id="section-7-8">As the <code>KeyPackage</code> is a structure which is stored in the Ratchet
Tree and updated depending on the evolution of this tree, each
modification of its content MUST be reflected by a change of its
signature. This allow other members to control the validity of the KeyPackage
at any time and in particular in the case of a newcomer joining the group.<a href="#section-7-8" class="pilcrow">¶</a></p>
<div id="client-capabilities">
<section id="section-7.1">
        <h3 id="name-client-capabilities">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-client-capabilities" class="section-name selfRef">Client Capabilities</a>
        </h3>
<p id="section-7.1-1">The <code>capabilities</code> extension indicates what protocol versions, ciphersuites, and
protocol extensions are supported by a client.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.1-2">
<pre>
struct {
    ProtocolVersion versions&lt;0..255&gt;;
    CipherSuite ciphersuites&lt;0..255&gt;;
    ExtensionType extensions&lt;0..255&gt;;
} Capabilities;
</pre><a href="#section-7.1-2" class="pilcrow">¶</a>
</div>
<p id="section-7.1-3">This extension MUST be always present in a KeyPackage.  Extensions that appear
in the <code>extensions</code> field of a KeyPackage MUST be included in the <code>extensions</code>
field of the <code>capabilities</code> extension.<a href="#section-7.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="lifetime">
<section id="section-7.2">
        <h3 id="name-lifetime">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-lifetime" class="section-name selfRef">Lifetime</a>
        </h3>
<p id="section-7.2-1">The <code>lifetime</code> extension represents the times between which clients will
consider a KeyPackage valid.  This time is represented as an absolute time,
measured in seconds since the Unix epoch (1970-01-01T00:00:00Z). A client MUST
NOT use the data in a KeyPackage for any processing before the <code>not_before</code>
date, or after the <code>not_after</code> date.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.2-2">
<pre>
uint64 not_before;
uint64 not_after;
</pre><a href="#section-7.2-2" class="pilcrow">¶</a>
</div>
<p id="section-7.2-3">Applications MUST define a maximum total lifetime that is acceptable for a
KeyPackage, and reject any KeyPackage where the total lifetime is longer than
this duration.<a href="#section-7.2-3" class="pilcrow">¶</a></p>
<p id="section-7.2-4">This extension MUST always be present in a KeyPackage.<a href="#section-7.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="keypackage-identifiers">
<section id="section-7.3">
        <h3 id="name-keypackage-identifiers">
<a href="#section-7.3" class="section-number selfRef">7.3. </a><a href="#name-keypackage-identifiers" class="section-name selfRef">KeyPackage Identifiers</a>
        </h3>
<p id="section-7.3-1">Within MLS, a KeyPackage is identified by its hash (see, e.g.,
<a href="#welcoming-new-members" class="xref">Section 10.2.1</a>).  The <code>key_id</code> extension allows applications to add
an explicit, application-defined identifier to a KeyPackage.<a href="#section-7.3-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.3-2">
<pre>
opaque key_id&lt;0..2^16-1&gt;;
</pre><a href="#section-7.3-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="parent-hash">
<section id="section-7.4">
        <h3 id="name-parent-hash">
<a href="#section-7.4" class="section-number selfRef">7.4. </a><a href="#name-parent-hash" class="section-name selfRef">Parent Hash</a>
        </h3>
<p id="section-7.4-1">The <code>parent_hash</code> extension serves to bind a KeyPackage to all the nodes
above it in the group's ratchet tree. This enforces the tree invariant, meaning
that malicious members can't lie about the state of the ratchet tree when they
send Welcome messages to new members.<a href="#section-7.4-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.4-2">
<pre>
opaque parent_hash&lt;0..255&gt;;
</pre><a href="#section-7.4-2" class="pilcrow">¶</a>
</div>
<p id="section-7.4-3">This extension MUST be present in all Updates that are sent as part of a Commit
message. If the extension is present, clients MUST verify that <code>parent_hash</code>
matches the hash of the leaf's parent node when represented as a ParentNode
struct.<a href="#section-7.4-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="tree-hashes">
<section id="section-7.5">
        <h3 id="name-tree-hashes">
<a href="#section-7.5" class="section-number selfRef">7.5. </a><a href="#name-tree-hashes" class="section-name selfRef">Tree Hashes</a>
        </h3>
<p id="section-7.5-1">To allow group members to verify that they agree on the public
cryptographic state of the group, this section defines a scheme for
generating a hash value that represents the contents of the group's
ratchet tree and the members' KeyPackages.<a href="#section-7.5-1" class="pilcrow">¶</a></p>
<p id="section-7.5-2">The hash of a tree is the hash of its root node, which we define
recursively, starting with the leaves.<a href="#section-7.5-2" class="pilcrow">¶</a></p>
<p id="section-7.5-3">Elements of the ratchet tree are called <code>Node</code> objects and
the leaves contain an optional <code>KeyPackage</code>, while the parents contain
an optional <code>ParentNode</code>.<a href="#section-7.5-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.5-4">
<pre>
struct {
    uint8 present;
    select (present) {
        case 0: struct{};
        case 1: T value;
    }
} optional&lt;T&gt;;

struct {
    HPKEPublicKey public_key;
    uint32 unmerged_leaves&lt;0..2^32-1&gt;;
    opaque parent_hash&lt;0..255&gt;;
} ParentNode;
</pre><a href="#section-7.5-4" class="pilcrow">¶</a>
</div>
<p id="section-7.5-5">When computing the hash of a parent node, the <code>ParentNodeHashInput</code>
structure is used:<a href="#section-7.5-5" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.5-6">
<pre>
struct {
    uint32 node_index;
    optional&lt;ParentNode&gt; parent_node;
    opaque left_hash&lt;0..255&gt;;
    opaque right_hash&lt;0..255&gt;;
} ParentNodeHashInput;
</pre><a href="#section-7.5-6" class="pilcrow">¶</a>
</div>
<p id="section-7.5-7">The <code>left_hash</code> and <code>right_hash</code> fields hold the hashes of the node's
left and right children, respectively. When computing the hash of
a leaf node, the hash of a <code>LeafNodeHashInput</code> object is used:<a href="#section-7.5-7" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.5-8">
<pre>
struct {
    uint32 node_index;
    optional&lt;KeyPackage&gt; key_package;
} LeafNodeHashInput;
</pre><a href="#section-7.5-8" class="pilcrow">¶</a>
</div>
<p id="section-7.5-9">Note that the <code>node_index</code> field contains the index of the leaf among the nodes
in the tree, not its index among the leaves; <code>node_index = 2 * leaf_index</code>.<a href="#section-7.5-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="group-state">
<section id="section-7.6">
        <h3 id="name-group-state">
<a href="#section-7.6" class="section-number selfRef">7.6. </a><a href="#name-group-state" class="section-name selfRef">Group State</a>
        </h3>
<p id="section-7.6-1">Each member of the group maintains a GroupContext object that
summarizes the state of the group:<a href="#section-7.6-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.6-2">
<pre>
struct {
    opaque group_id&lt;0..255&gt;;
    uint64 epoch;
    opaque tree_hash&lt;0..255&gt;;
    opaque confirmed_transcript_hash&lt;0..255&gt;;
    Extension extensions&lt;0..2^32-1&gt;;
} GroupContext;
</pre><a href="#section-7.6-2" class="pilcrow">¶</a>
</div>
<p id="section-7.6-3">The fields in this state have the following semantics:<a href="#section-7.6-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.6-4.1">The <code>group_id</code> field is an application-defined identifier for the
group.<a href="#section-7.6-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.6-4.2">The <code>epoch</code> field represents the current version of the group key.<a href="#section-7.6-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.6-4.3">The <code>tree_hash</code> field contains a commitment to the contents of the
group's ratchet tree and the credentials for the members of the
group, as described in <a href="#tree-hashes" class="xref">Section 7.5</a>.<a href="#section-7.6-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.6-4.4">The <code>confirmed_transcript_hash</code> field contains a running hash over
the messages that led to this state.<a href="#section-7.6-4.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-7.6-5">When a new member is added to the group, an existing member of the
group provides the new member with a Welcome message.  The Welcome
message provides the information the new member needs to initialize
its GroupContext.<a href="#section-7.6-5" class="pilcrow">¶</a></p>
<p id="section-7.6-6">Different changes to the group will have different effects on the group state.
These effects are described in their respective subsections of <a href="#proposals" class="xref">Section 10.1</a>.
The following general rules apply:<a href="#section-7.6-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.6-7.1">The <code>group_id</code> field is constant<a href="#section-7.6-7.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.6-7.2">The <code>epoch</code> field increments by one for each Commit message that
is processed<a href="#section-7.6-7.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.6-7.3">The <code>tree_hash</code> is updated to represent the current tree and
credentials<a href="#section-7.6-7.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.6-7.4">The <code>confirmed_transcript_hash</code> is updated with the data for an
MLSPlaintext message encoding a Commit message in two parts:<a href="#section-7.6-7.4" class="pilcrow">¶</a>
</li>
        </ul>
<div class="artwork art-text alignLeft" id="section-7.6-8">
<pre>
struct {
    opaque group_id&lt;0..255&gt;;
    uint64 epoch;
    Sender sender;
    ContentType content_type = commit;
    Commit commit;
} MLSPlaintextCommitContent;

struct {
    opaque confirmation_tag&lt;0..255&gt;;
    opaque signature&lt;0..2^16-1&gt;;
} MLSPlaintextCommitAuthData;

interim_transcript_hash_[0] = ""; // zero-length octet string

confirmed_transcript_hash_[n] =
    Hash(interim_transcript_hash_[n] ||
        MLSPlaintextCommitContent_[n]);

interim_transcript_hash_[n+1] =
    Hash(confirmed_transcript_hash_[n] ||
        MLSPlaintextCommitAuthData_[n]);
</pre><a href="#section-7.6-8" class="pilcrow">¶</a>
</div>
<p id="section-7.6-9">Thus the <code>confirmed_transcript_hash</code> field in a GroupContext object represents a
transcript over the whole history of MLSPlaintext Commit messages, up to the
confirmation tag field in the current MLSPlaintext message.  The confirmation tag and
signature fields are then included in the transcript for the next epoch.  The
interim transcript hash is passed to new members in the GroupInfo struct, and
enables existing members to incorporate a Commit message into the transcript
without having to store the whole MLSPlaintextCommitAuthData structure.<a href="#section-7.6-9" class="pilcrow">¶</a></p>
<p id="section-7.6-10">As shown above, when a new group is created, the <code>interim_transcript_hash</code> field
is set to the zero-length octet string.<a href="#section-7.6-10" class="pilcrow">¶</a></p>
</section>
</div>
<div id="update-paths">
<section id="section-7.7">
        <h3 id="name-update-paths">
<a href="#section-7.7" class="section-number selfRef">7.7. </a><a href="#name-update-paths" class="section-name selfRef">Update Paths</a>
        </h3>
<p id="section-7.7-1">As described in <a href="#commit" class="xref">Section 10.2</a>, each MLS Commit message may optionally
transmit a KeyPackage leaf and node values along its direct path.
The path contains a public key and encrypted secret value for all
intermediate nodes in the path above the leaf.  The path is ordered
from the closest node to the leaf to the root; each node MUST be the
parent of its predecessor.<a href="#section-7.7-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.7-2">
<pre>
struct {
    opaque kem_output&lt;0..2^16-1&gt;;
    opaque ciphertext&lt;0..2^16-1&gt;;
} HPKECiphertext;

struct {
    HPKEPublicKey public_key;
    HPKECiphertext encrypted_path_secret&lt;0..2^32-1&gt;;
} UpdatePathNode;

struct {
    KeyPackage leaf_key_package;
    UpdatePathNode nodes&lt;0..2^32-1&gt;;
} UpdatePath;
</pre><a href="#section-7.7-2" class="pilcrow">¶</a>
</div>
<p id="section-7.7-3">The number of ciphertexts in the <code>encrypted_path_secret</code> vector MUST
be equal to the length of the resolution of the corresponding copath
node.  Each ciphertext in the list is the encryption to the
corresponding node in the resolution.<a href="#section-7.7-3" class="pilcrow">¶</a></p>
<p id="section-7.7-4">The HPKECiphertext values are computed as<a href="#section-7.7-4" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.7-5">
<pre>
kem_output, context = SetupBaseS(node_public_key, "")
ciphertext = context.Seal(group_context, path_secret)
</pre><a href="#section-7.7-5" class="pilcrow">¶</a>
</div>
<p id="section-7.7-6">where <code>node_public_key</code> is the public key of the node that the path
secret is being encrypted for, group_context is the current GroupContext object
for the group, and the functions <code>SetupBaseS</code> and
<code>Seal</code> are defined according to <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span>.<a href="#section-7.7-6" class="pilcrow">¶</a></p>
<p id="section-7.7-7">Decryption is performed in the corresponding way, using the private
key of the resolution node and the ephemeral public key
transmitted in the message.<a href="#section-7.7-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="key-schedule">
<section id="section-7.8">
        <h3 id="name-key-schedule">
<a href="#section-7.8" class="section-number selfRef">7.8. </a><a href="#name-key-schedule" class="section-name selfRef">Key Schedule</a>
        </h3>
<p id="section-7.8-1">Group keys are derived using the <code>Extract</code> and <code>Expand</code> functions from the KDF
for the group's ciphersuite, as well as the functions defined below:<a href="#section-7.8-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.8-2">
<pre>
ExpandWithLabel(Secret, Label, Context, Length) =
    KDF.Expand(Secret, KDFLabel, Length)

Where KDFLabel is specified as:

struct {
    uint16 length = Length;
    opaque label&lt;7..255&gt; = "mls10 " + Label;
    opaque context&lt;0..2^32-1&gt; = Context;
} KDFLabel;

DeriveSecret(Secret, Label) =
    ExpandWithLabel(Secret, Label, "", KDF.Nh)
</pre><a href="#section-7.8-2" class="pilcrow">¶</a>
</div>
<p id="section-7.8-3">The value <code>KDF.Nh</code> is the size of an output from <code>KDF.Extract</code>, in bytes.  In
the below diagram:<a href="#section-7.8-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.8-4.1">KDF.Extract takes its salt argument from the top and its IKM
argument from the left<a href="#section-7.8-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.8-4.2">DeriveSecret takes its Secret argument from the incoming arrow<a href="#section-7.8-4.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-7.8-5">When processing a handshake message, a client combines the
following information to derive new epoch secrets:<a href="#section-7.8-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.8-6.1">The init secret from the previous epoch<a href="#section-7.8-6.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.8-6.2">The commit secret for the current epoch<a href="#section-7.8-6.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.8-6.3">The GroupContext object for current epoch<a href="#section-7.8-6.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-7.8-7">Given these inputs, the derivation of secrets for an epoch
proceeds as shown in the following diagram:<a href="#section-7.8-7" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.8-8">
<pre>
                  init_secret_[n-1]
                        |
                        V
   commit_secret -&gt; KDF.Extract = joiner_secret
                        |
                        +--&gt; DeriveSecret(., "welcome")
                        |    = welcome_secret
                        |
                        V
                  DeriveSecret(., "member")
                        |
                        V
      PSK (or 0) -&gt; KDF.Extract = member_secret
                        |
                        V
                  DeriveSecret(., "epoch")
                        |
                        V
GroupContext_[n] -&gt; KDF.Extract = epoch_secret
                        |
                        +--&gt; DeriveSecret(., &lt;label&gt;)
                        |    = &lt;secret&gt;
                        |
                        V
                  DeriveSecret(., "init")
                        |
                        V
                  init_secret_[n]
</pre><a href="#section-7.8-8" class="pilcrow">¶</a>
</div>
<p id="section-7.8-9">A number of secrets are derived from the epoch secret for different purposes:<a href="#section-7.8-9" class="pilcrow">¶</a></p>
<table class="center" id="table-2">
          <caption><a href="#table-2" class="selfRef">Table 2</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Secret</th>
              <th class="text-left" rowspan="1" colspan="1">Label</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">
                <code>sender_data_secret</code>
</td>
              <td class="text-left" rowspan="1" colspan="1">"sender data"</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">
                <code>handshake_secret</code>
</td>
              <td class="text-left" rowspan="1" colspan="1">"handshake"</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">
                <code>application_secret</code>
</td>
              <td class="text-left" rowspan="1" colspan="1">"app"</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">
                <code>exporter_secret</code>
</td>
              <td class="text-left" rowspan="1" colspan="1">"exporter"</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">
                <code>confirmation_key</code>
</td>
              <td class="text-left" rowspan="1" colspan="1">"confirm"</td>
            </tr>
          </tbody>
        </table>
</section>
</div>
<div id="pre-shared-keys">
<section id="section-7.9">
        <h3 id="name-pre-shared-keys">
<a href="#section-7.9" class="section-number selfRef">7.9. </a><a href="#name-pre-shared-keys" class="section-name selfRef">Pre-Shared Keys</a>
        </h3>
<p id="section-7.9-1">Groups which already have an out-of-band mechanism to generate
shared group secrets can inject those in the MLS key schedule to seed
the MLS group secrets computations by this external entropy.<a href="#section-7.9-1" class="pilcrow">¶</a></p>
<p id="section-7.9-2">At any epoch, including the initial state, an application can decide
to synchronize the injection of a PSK into the MLS key schedule.<a href="#section-7.9-2" class="pilcrow">¶</a></p>
<p id="section-7.9-3">This mechanism can be used to improve security in the cases where
having a full run of updates across members is too expensive or in
the case where the external group key establishment mechanism provides
stronger security against classical or quantum adversaries.<a href="#section-7.9-3" class="pilcrow">¶</a></p>
<p id="section-7.9-4">The security level associated with the PSK injected in the key schedule
SHOULD match at least the security level of the ciphersuite in use in
the group.<a href="#section-7.9-4" class="pilcrow">¶</a></p>
<p id="section-7.9-5">Note that, as a PSK may have a different lifetime than an update, it
does not necessarily provide the same Forward Secrecy (FS) or Post-Compromise
Security (PCS) guarantees as a Commit message.<a href="#section-7.9-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encryption-keys">
<section id="section-7.10">
        <h3 id="name-encryption-keys">
<a href="#section-7.10" class="section-number selfRef">7.10. </a><a href="#name-encryption-keys" class="section-name selfRef">Encryption Keys</a>
        </h3>
<p id="section-7.10-1">As described in <a href="#message-framing" class="xref">Section 8</a>, MLS encrypts three different
types of information:<a href="#section-7.10-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.10-2.1">Metadata (sender information)<a href="#section-7.10-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.10-2.2">Handshake messages (Proposal and Commit)<a href="#section-7.10-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-7.10-2.3">Application messages<a href="#section-7.10-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-7.10-3">The sender information used to look up the key for content encryption is
encrypted with an AEAD where the key and nonce are derived from both
<code>sender_data_secret</code> and a sample of the encrypted message content.<a href="#section-7.10-3" class="pilcrow">¶</a></p>
<p id="section-7.10-4">For handshake and application messages, a sequence of keys is derived via a
"sender ratchet".  Each sender has their own sender ratchet, and each step along
the ratchet is called a "generation".<a href="#section-7.10-4" class="pilcrow">¶</a></p>
<p id="section-7.10-5">A sender ratchet starts from a per-sender base secret.  For application keys,
the base secret is derived as described in <a href="#astree" class="xref">Section 13.1</a>.  For handshake keys, base
secrets are derived directly from the <code>handshake_secret</code>.<a href="#section-7.10-5" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.10-6">
<pre>
application_secret_[sender]_[0] = astree_node_[N]_secret

handshake_secret_[sender]_[0] =
    ExpandWithLabel(handshake_secret, "hs", [sender], nonce_length)
</pre><a href="#section-7.10-6" class="pilcrow">¶</a>
</div>
<p id="section-7.10-7">The base secret for each sender is used to initiate a symmetric hash ratchet
which generates a sequence of keys and nonces. The sender uses the j-th
key/nonce pair in the sequence to encrypt (using the AEAD) the j-th message they
send during that epoch.  In particular, each key/nonce pair MUST NOT be used to
encrypt more than one message.<a href="#section-7.10-7" class="pilcrow">¶</a></p>
<p id="section-7.10-8">Keys, nonces, and the secrets in ratchets are derived using
DeriveAppSecret. The context in a given call consists of the index
of the sender's leaf in the ratchet tree and the current position in
the ratchet.  In particular, the index of the sender's leaf in the
ratchet tree is the same as the index of the leaf in the AS Tree
used to initialize the sender's ratchet.<a href="#section-7.10-8" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.10-9">
<pre>
ratchet_secret_[N]_[j]
      |
      +--&gt; DeriveAppSecret(., "nonce", N, j, AEAD.nonce_length)
      |    = ratchet_nonce_[N]_[j]
      |
      +--&gt; DeriveAppSecret(., "key", N, j, AEAD.key_length)
      |    = ratchet_key_[N]_[j]
      |
      V
DeriveAppSecret(., "secret", N, j, Hash.length)
= ratchet_secret_[N]_[j+1]
</pre><a href="#section-7.10-9" class="pilcrow">¶</a>
</div>
<p id="section-7.10-10">Here, AEAD.nonce_length and AEAD.key_length denote the lengths
in bytes of the nonce and key for the AEAD scheme defined by
the ciphersuite.  "Ratchet" should be understood to mean "handshake" or
"application" depending on the context.<a href="#section-7.10-10" class="pilcrow">¶</a></p>
</section>
</div>
<div id="exporters">
<section id="section-7.11">
        <h3 id="name-exporters">
<a href="#section-7.11" class="section-number selfRef">7.11. </a><a href="#name-exporters" class="section-name selfRef">Exporters</a>
        </h3>
<p id="section-7.11-1">The main MLS key schedule provides an <code>exporter_secret</code> which can
be used by an application as the basis to derive new secrets called
<code>exported_value</code> outside the MLS layer.<a href="#section-7.11-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.11-2">
<pre>
MLS-Exporter(Label, Context, key_length) =
       ExpandWithLabel(DeriveSecret(exporter_secret, Label),
                         "exporter", Hash(Context), key_length)
</pre><a href="#section-7.11-2" class="pilcrow">¶</a>
</div>
<p id="section-7.11-3">The context used for the derivation of the <code>exported_value</code> MAY be
empty while each application SHOULD provide a unique label as an input
of the ExpandWithLabel for each use case. This is to prevent two
exported outputs from being generated with the same values and used
for different functionalities.<a href="#section-7.11-3" class="pilcrow">¶</a></p>
<p id="section-7.11-4">The exported values are bound to the Group epoch from which the
<code>exporter_secret</code> is derived, hence reflects a particular state of
the Group.<a href="#section-7.11-4" class="pilcrow">¶</a></p>
<p id="section-7.11-5">It is RECOMMENDED for the application generating exported values
to refresh those values after a group operation is processed.<a href="#section-7.11-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="message-framing">
<section id="section-8">
      <h2 id="name-message-framing">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-message-framing" class="section-name selfRef">Message Framing</a>
      </h2>
<p id="section-8-1">Handshake and application messages use a common framing structure.
This framing provides encryption to ensure confidentiality within the
group, as well as signing to authenticate the sender within the group.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">The two main structures involved are MLSPlaintext and MLSCiphertext.
MLSCiphertext represents a signed and encrypted message, with
protections for both the content of the message and related
metadata.  MLSPlaintext represents a message that is only signed,
and not encrypted.  Applications MUST use MLSCiphertext to encrypt
application messages and SHOULD use MLSCiphertext to encode
handshake messages, but MAY transmit handshake messages encoded
as MLSPlaintext objects in cases where it is necessary for the
delivery service to examine such messages.<a href="#section-8-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-8-3">
<pre>
enum {
    reserved(0),
    application(1),
    proposal(2),
    commit(3),
    (255)
} ContentType;

enum {
    reserved(0),
    member(1),
    preconfigured(2),
    new_member(3),
    (255)
} SenderType;

struct {
    SenderType sender_type;
    uint32 sender;
} Sender;

struct {
    opaque group_id&lt;0..255&gt;;
    uint64 epoch;
    Sender sender;
    opaque authenticated_data&lt;0..2^32-1&gt;;

    ContentType content_type;
    select (MLSPlaintext.content_type) {
        case application:
          opaque application_data&lt;0..2^32-1&gt;;

        case proposal:
          Proposal proposal;

        case commit:
          Commit commit;
          opaque confirmation_tag&lt;0..255&gt;;
    }

    opaque signature&lt;0..2^16-1&gt;;
} MLSPlaintext;

struct {
    opaque group_id&lt;0..255&gt;;
    uint64 epoch;
    ContentType content_type;
    opaque authenticated_data&lt;0..2^32-1&gt;;
    opaque encrypted_sender_data&lt;0..255&gt;;
    opaque ciphertext&lt;0..2^32-1&gt;;
} MLSCiphertext;
</pre><a href="#section-8-3" class="pilcrow">¶</a>
</div>
<p id="section-8-4">External sender types are sent as MLSPlaintext, see <a href="#external-proposals" class="xref">Section 10.1.4</a>
for their use.<a href="#section-8-4" class="pilcrow">¶</a></p>
<p id="section-8-5">The remainder of this section describes how to compute the signature of an
MLSPlaintext object and how to convert it to an MLSCiphertext object for
<code>member</code> sender types.  The steps are:<a href="#section-8-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8-6.1">Set group_id, epoch, content_type and authenticated_data fields from the
MLSPlaintext object directly<a href="#section-8-6.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-8-6.2">Identify the key and key generation depending on the content type<a href="#section-8-6.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-8-6.3">Encrypt an MLSCiphertextContent for the ciphertext field using the key
identified and MLSPlaintext object<a href="#section-8-6.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-8-6.4">Encrypt the sender data using a key and nonce derived from the
<code>sender_data_secret</code> for the epoch and a sample of the encrypted
MLSCiphertextContent.<a href="#section-8-6.4" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-8-7">Decryption is done by decrypting the sender data, then the message, and then
verifying the content signature.<a href="#section-8-7" class="pilcrow">¶</a></p>
<p id="section-8-8">The following sections describe the encryption and signing processes in detail.<a href="#section-8-8" class="pilcrow">¶</a></p>
<div id="content-signing">
<section id="section-8.1">
        <h3 id="name-content-signing">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-content-signing" class="section-name selfRef">Content Signing</a>
        </h3>
<p id="section-8.1-1">The <code>signature</code> field in an MLSPlaintext object is computed using the
signing private key corresponding to the credential at the leaf in
the tree indicated by the sender field.  The signature covers the
plaintext metadata and message content, which is all of
MLSPlaintext except for the <code>signature</code> field.  The signature also covers the
GroupContext for the current epoch, so that signatures are specific to a given
group and epoch.<a href="#section-8.1-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-8.1-2">
<pre>
struct {
    select (MLSPlaintextTBS.sender.sender_type) {
        case member:
            GroupContext context;
    }

    opaque group_id&lt;0..255&gt;;
    uint64 epoch;
    Sender sender;
    opaque authenticated_data&lt;0..2^32-1&gt;;

    ContentType content_type;
    select (MLSPlaintextTBS.content_type) {
        case application:
          opaque application_data&lt;0..2^32-1&gt;;

        case proposal:
          Proposal proposal;

        case commit:
          Commit commit;
          opaque confirmation_tag&lt;0..255&gt;;
    }
} MLSPlaintextTBS;
</pre><a href="#section-8.1-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="content-encryption">
<section id="section-8.2">
        <h3 id="name-content-encryption">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-content-encryption" class="section-name selfRef">Content Encryption</a>
        </h3>
<p id="section-8.2-1">The <code>ciphertext</code> field of the MLSCiphertext object is produced by
supplying the inputs described below to the AEAD function specified
by the ciphersuite in use.  The plaintext input contains content and
signature of the MLSPlaintext, plus optional padding.  These values
are encoded in the following form:<a href="#section-8.2-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-8.2-2">
<pre>
struct {
    select (MLSCiphertext.content_type) {
        case application:
          opaque application_data&lt;0..2^32-1&gt;;

        case proposal:
          Proposal proposal;

        case commit:
          Commit commit;
          opaque confirmation_tag&lt;0..255&gt;;
    }

    opaque signature&lt;0..2^16-1&gt;;
    opaque padding&lt;0..2^16-1&gt;;
} MLSCiphertextContent;
</pre><a href="#section-8.2-2" class="pilcrow">¶</a>
</div>
<p id="section-8.2-3">The key and nonce used for the encryption of the message depend on the
content type of the message.  The sender chooses the handshake key for a
handshake message or an unused generation from its (per-sender)
application key chain for the current epoch, according to the type
of message being encrypted.<a href="#section-8.2-3" class="pilcrow">¶</a></p>
<p id="section-8.2-4">Before use in the encryption operation, the nonce is XORed with a fresh random
value to guard against reuse.  Because the key schedule generates nonces
deterministically, a client must keep persistent state as to where in the key
schedule it is; if this persistent state is lost or corrupted, a client might
reuse a generation that has already been used, causing reuse of a key/nonce pair.<a href="#section-8.2-4" class="pilcrow">¶</a></p>
<p id="section-8.2-5">To avoid this situation, the sender of a message MUST generate a fresh random
4-byte "reuse guard" value and XOR it with the first four bytes of the nonce
from the key schedule before using the nonce for encryption.  The sender MUST
include the reuse guard in the <code>reuse_guard</code> field of the sender data object, so
that the recipient of the message can use it to compute the nonce to be used for
decryption.<a href="#section-8.2-5" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-8.2-6">
<pre>
+-+-+-+-+---------...---+
|   Key Schedule Nonce  |
+-+-+-+-+---------...---+
           XOR
+-+-+-+-+---------...---+
| Guard |       0       |
+-+-+-+-+---------...---+
           ===
+-+-+-+-+---------...---+
| Encrypt/Decrypt Nonce |
+-+-+-+-+---------...---+
</pre><a href="#section-8.2-6" class="pilcrow">¶</a>
</div>
<p id="section-8.2-7">The Additional Authenticated Data (AAD) input to the encryption
contains an object of the following form, with the values used to
identify the key and nonce:<a href="#section-8.2-7" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-8.2-8">
<pre>
struct {
    opaque group_id&lt;0..255&gt;;
    uint64 epoch;
    ContentType content_type;
    opaque authenticated_data&lt;0..2^32-1&gt;;
    opaque encrypted_sender_data&lt;0..255&gt;;
} MLSCiphertextContentAAD;
</pre><a href="#section-8.2-8" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="sender-data-encryption">
<section id="section-8.3">
        <h3 id="name-sender-data-encryption">
<a href="#section-8.3" class="section-number selfRef">8.3. </a><a href="#name-sender-data-encryption" class="section-name selfRef">Sender Data Encryption</a>
        </h3>
<p id="section-8.3-1">The "sender data" used to look up the key for the content encryption is
encrypted with the ciphersuite's AEAD with a key and nonce derived from both the
<code>sender_data_secret</code> and a sample of the encrypted content. Before being
encrypted, the sender data is encoded as an object of the following form:<a href="#section-8.3-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-8.3-2">
<pre>
struct {
    uint32 sender;
    uint32 generation;
    opaque reuse_guard[4];
} MLSSenderData;
</pre><a href="#section-8.3-2" class="pilcrow">¶</a>
</div>
<p id="section-8.3-3">MLSSenderData.sender is assumed to be a <code>member</code> sender type.  When constructing
an MLSSenderData from a Sender object, the sender MUST verify Sender.sender_type
is <code>member</code> and use Sender.sender for MLSSenderData.sender.<a href="#section-8.3-3" class="pilcrow">¶</a></p>
<p id="section-8.3-4">The <code>reuse_guard</code> field contains a fresh random value used to avoid nonce reuse
in the case of state loss or corruption, as described in <a href="#content-encryption" class="xref">Section 8.2</a>.<a href="#section-8.3-4" class="pilcrow">¶</a></p>
<p id="section-8.3-5">The key and nonce provided to the AEAD are computed as the KDF of the first
<code>KDF.Nh</code> bytes of the ciphertext generated in the previous section. If the
length of the ciphertext is less than <code>KDF.Nh</code>, the whole ciphertext is used
without padding. In pseudocode, the key and nonce are derived as:<a href="#section-8.3-5" class="pilcrow">¶</a></p>
<p id="section-8.3-6">```
ciphertext_sample = ciphertext[0..KDF.Nh-1]<a href="#section-8.3-6" class="pilcrow">¶</a></p>
<p id="section-8.3-7">sender_data_key = ExpandWithLabel(sender_data_secret, "key", ciphertext_sample, AEAD.Nk)
sender_data_nonce = ExpandWithLabel(sender_data_secret, "nonce", ciphertext_sample, AEAD.Nn)
```<a href="#section-8.3-7" class="pilcrow">¶</a></p>
<p id="section-8.3-8">The Additional Authenticated Data (AAD) for the SenderData ciphertext is all the
fields of MLSCiphertext excluding <code>encrypted_sender_data</code>:<a href="#section-8.3-8" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-8.3-9">
<pre>
struct {
    opaque group_id&lt;0..255&gt;;
    uint64 epoch;
    ContentType content_type;
} MLSSenderDataAAD;
</pre><a href="#section-8.3-9" class="pilcrow">¶</a>
</div>
<p id="section-8.3-10">When parsing a SenderData struct as part of message decryption, the
recipient MUST verify that the sender field represents an occupied
leaf in the ratchet tree.  In particular, the sender index value
MUST be less than the number of leaves in the tree.<a href="#section-8.3-10" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="group-creation">
<section id="section-9">
      <h2 id="name-group-creation">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-group-creation" class="section-name selfRef">Group Creation</a>
      </h2>
<p id="section-9-1">A group is always created with a single member, the "creator".  The other
members are added when the creator effectively sends itself an Add proposal and
commits it, then sends the corresponding Welcome message to the new
participants.  These processes are described in detail in <a href="#add" class="xref">Section 10.1.1</a>, <a href="#commit" class="xref">Section 10.2</a>,
and <a href="#welcoming-new-members" class="xref">Section 10.2.1</a>.<a href="#section-9-1" class="pilcrow">¶</a></p>
<p id="section-9-2">The creator of a group MUST take the following steps to initialize the group:<a href="#section-9-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9-3.1">Fetch KeyPackages for the members to be added, and select a version and
ciphersuite according to the capabilities of the members.  To protect against
downgrade attacks, the creator MUST use the <code>capabilities</code> extensions
in these KeyPackages to verify that the
chosen version and ciphersuite is the best option supported by all members.<a href="#section-9-3.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-3.2">
          <p id="section-9-3.2.1">Initialize a one-member group with the following initial values (where "0"
represents an all-zero vector of size Hash.length):<a href="#section-9-3.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9-3.2.2.1">Ratchet tree: A tree with a single node, a leaf containing an HPKE public
key and credential for the creator<a href="#section-9-3.2.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-9-3.2.2.2">Group ID: A value set by the creator<a href="#section-9-3.2.2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-9-3.2.2.3">Epoch: 0<a href="#section-9-3.2.2.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-9-3.2.2.4">Tree hash: The root hash of the above ratchet tree<a href="#section-9-3.2.2.4" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-9-3.2.2.5">Confirmed transcript hash: 0<a href="#section-9-3.2.2.5" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-9-3.2.2.6">Interim transcript hash: 0<a href="#section-9-3.2.2.6" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-9-3.2.2.7">Init secret: a fresh random value of size <code>KDF.Nh</code><a href="#section-9-3.2.2.7" class="pilcrow">¶</a>
</li>
          </ul>
</li>
        <li class="normal" id="section-9-3.3">For each member, construct an Add proposal from the KeyPackage for that
member (see <a href="#add" class="xref">Section 10.1.1</a>)<a href="#section-9-3.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-3.4">Construct a Commit message that commits all of the Add proposals, in any order
chosen by the creator (see <a href="#commit" class="xref">Section 10.2</a>)<a href="#section-9-3.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-3.5">Process the Commit message to obtain a new group state (for the epoch in which
the new members are added) and a Welcome message<a href="#section-9-3.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-3.6">Transmit the Welcome message to the other new members<a href="#section-9-3.6" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-9-4">The recipient of a Welcome message processes it as described in
<a href="#welcoming-new-members" class="xref">Section 10.2.1</a>.<a href="#section-9-4" class="pilcrow">¶</a></p>
<p id="section-9-5">In principle, the above process could be streamlined by having the
creator directly create a tree and choose a random value for first
epoch's epoch secret.  We follow the steps above because it removes
unnecessary choices, by which, for example, bad randomness could be
introduced.  The only choices the creator makes here are its own
KeyPackage, the leaf secret from which the Commit is built, and the
intermediate key pairs along the direct path to the root.<a href="#section-9-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="group-evolution">
<section id="section-10">
      <h2 id="name-group-evolution">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-group-evolution" class="section-name selfRef">Group Evolution</a>
      </h2>
<p id="section-10-1">Over the lifetime of a group, its membership can change, and existing members
might want to change their keys in order to achieve post-compromise security.
In MLS, each such change is accomplished by a two-step process:<a href="#section-10-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10-2">
<li id="section-10-2.1">A proposal to make the change is broadcast to the group in a Proposal message<a href="#section-10-2.1" class="pilcrow">¶</a>
</li>
        <li id="section-10-2.2">A member of the group broadcasts a Commit message that causes one or more
proposed changes to enter into effect<a href="#section-10-2.2" class="pilcrow">¶</a>
</li>
      </ol>
<p id="section-10-3">The group thus evolves from one cryptographic state to another each time a
Commit message is sent and processed.  These states are referred to as "epochs"
and are uniquely identified among states of the group by eight-octet epoch values.
When a new group is initialized, its initial state epoch is 0x0000000000000000.  Each time
a state transition occurs, the epoch number is incremented by one.<a href="#section-10-3" class="pilcrow">¶</a></p>
<div id="proposals">
<section id="section-10.1">
        <h3 id="name-proposals">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-proposals" class="section-name selfRef">Proposals</a>
        </h3>
<p id="section-10.1-1">Proposals are included in an MLSPlaintext by way of a Proposal structure that
indicates their type:<a href="#section-10.1-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.1-2">
<pre>
enum {
    reserved(0),
    add(1),
    update(2),
    remove(3),
    (255)
} ProposalType;

struct {
    ProposalType msg_type;
    select (Proposal.msg_type) {
        case add:    Add;
        case update: Update;
        case remove: Remove;
    };
} Proposal;
</pre><a href="#section-10.1-2" class="pilcrow">¶</a>
</div>
<p id="section-10.1-3">On receiving an MLSPlaintext containing a Proposal, a client MUST verify the
signature on the enclosing MLSPlaintext.  If the signature verifies
successfully, then the Proposal should be cached in such a way that it can be
retrieved using a ProposalID in a later Commit message.<a href="#section-10.1-3" class="pilcrow">¶</a></p>
<div id="add">
<section id="section-10.1.1">
          <h4 id="name-add">
<a href="#section-10.1.1" class="section-number selfRef">10.1.1. </a><a href="#name-add" class="section-name selfRef">Add</a>
          </h4>
<p id="section-10.1.1-1">An Add proposal requests that a client with a specified KeyPackage be added
to the group.<a href="#section-10.1.1-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.1.1-2">
<pre>
struct {
    KeyPackage key_package;
} Add;
</pre><a href="#section-10.1.1-2" class="pilcrow">¶</a>
</div>
<p id="section-10.1.1-3">The proposer of the Add does not control where in the group's ratchet tree the
new member is added.  Instead, the sender of the Commit message chooses a
location for each added member and states it in the Commit message.<a href="#section-10.1.1-3" class="pilcrow">¶</a></p>
<p id="section-10.1.1-4">An Add is applied after being included in a Commit message.  The position of the
Add in the list of proposals determines the leaf index <code>index</code> where the new member
will be added.  For the first Add in the Commit, <code>index</code> is the leftmost empty
leaf in the tree, for the second Add, the next empty leaf to the right, etc.<a href="#section-10.1.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.1.1-5.1">If necessary, extend the tree to the right until it has at least index + 1
leaves<a href="#section-10.1.1-5.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.1.1-5.2">For each non-blank intermediate node along the path from the leaf at position
<code>index</code> to the root, add <code>index</code> to the <code>unmerged_leaves</code> list for the node.<a href="#section-10.1.1-5.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.1.1-5.3">Set the leaf node in the tree at position <code>index</code> to a new node containing the
public key from the KeyPackage in the Add, as well as the credential under
which the KeyPackage was signed<a href="#section-10.1.1-5.3" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="update">
<section id="section-10.1.2">
          <h4 id="name-update">
<a href="#section-10.1.2" class="section-number selfRef">10.1.2. </a><a href="#name-update" class="section-name selfRef">Update</a>
          </h4>
<p id="section-10.1.2-1">An Update proposal is a similar mechanism to Add with the distinction
that it is the sender's leaf KeyPackage in the tree which would be
updated with a new KeyPackage.<a href="#section-10.1.2-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.1.2-2">
<pre>
struct {
    KeyPackage key_package;
} Update;
</pre><a href="#section-10.1.2-2" class="pilcrow">¶</a>
</div>
<p id="section-10.1.2-3">A member of the group applies an Update message by taking the following steps:<a href="#section-10.1.2-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.1.2-4.1">Replace the sender's leaf KeyPackage with the one contained in
the Update proposal<a href="#section-10.1.2-4.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.1.2-4.2">Blank the intermediate nodes along the path from the sender's leaf to the root<a href="#section-10.1.2-4.2" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="remove">
<section id="section-10.1.3">
          <h4 id="name-remove">
<a href="#section-10.1.3" class="section-number selfRef">10.1.3. </a><a href="#name-remove" class="section-name selfRef">Remove</a>
          </h4>
<p id="section-10.1.3-1">A Remove proposal requests that the client at a specified index in the tree be
removed from the group.<a href="#section-10.1.3-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.1.3-2">
<pre>
struct {
    uint32 removed;
} Remove;
</pre><a href="#section-10.1.3-2" class="pilcrow">¶</a>
</div>
<p id="section-10.1.3-3">A member of the group applies a Remove message by taking the following steps:<a href="#section-10.1.3-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.1.3-4.1">Replace the leaf node at position <code>removed</code> with a blank node<a href="#section-10.1.3-4.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.1.3-4.2">Blank the intermediate nodes along the path from the removed leaf to the root<a href="#section-10.1.3-4.2" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="external-proposals">
<section id="section-10.1.4">
          <h4 id="name-external-proposals">
<a href="#section-10.1.4" class="section-number selfRef">10.1.4. </a><a href="#name-external-proposals" class="section-name selfRef">External Proposals</a>
          </h4>
<p id="section-10.1.4-1">Add and Remove proposals can be constructed and sent to the group by a party
that is outside the group.  For example, a Delivery Service might propose to
remove a member of a group who has been inactive for a long time, or propose adding
a newly-hired staff member to a group representing a real-world team.  Proposals
originating outside the group are identified by a <code>preconfigured</code> or
<code>new_member</code> SenderType in MLSPlaintext.<a href="#section-10.1.4-1" class="pilcrow">¶</a></p>
<p id="section-10.1.4-2">The <code>new_member</code> SenderType is used for clients proposing that they themselves
be added.  For this ID type the sender value MUST be zero and the Proposal type
MUST be Add. The MLSPlaintext MUST be signed with the private key corresponding
to the KeyPackage in the Add message.  Recipients MUST verify that the
MLSPlaintext carrying the Proposal message is validly signed with this key.<a href="#section-10.1.4-2" class="pilcrow">¶</a></p>
<p id="section-10.1.4-3">The <code>preconfigured</code> SenderType is reserved for signers that are pre-provisioned
to the clients within a group.  If proposals with these sender IDs are to be
accepted within a group, the members of the group MUST be provisioned by the
application with a mapping between these IDs and authorized signing keys.
Recipients MUST verify that the MLSPlaintext carrying the Proposal message is
validly signed with the corresponding key. To ensure consistent handling of
external proposals, the application MUST ensure that the members of a group
have the same mapping and apply the same policies to external proposals.<a href="#section-10.1.4-3" class="pilcrow">¶</a></p>
<p id="section-10.1.4-4">An external proposal MUST be sent as an MLSPlaintext
object, since the sender will not have the keys necessary to construct an
MLSCiphertext object.<a href="#section-10.1.4-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="commit">
<section id="section-10.2">
        <h3 id="name-commit">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-commit" class="section-name selfRef">Commit</a>
        </h3>
<p id="section-10.2-1">A Commit message initiates a new epoch for the group, based on a collection of
Proposals. It instructs group members to update their representation of the
state of the group by applying the proposals and advancing the key schedule.<a href="#section-10.2-1" class="pilcrow">¶</a></p>
<p id="section-10.2-2">Each proposal covered by the Commit is identified by a ProposalID value, which
contains the hash of the MLSPlaintext in which the Proposal was sent, using the
hash function from the group's ciphersuite.<a href="#section-10.2-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.2-3">
<pre>
opaque ProposalID&lt;0..255&gt;;

struct {
    ProposalID proposals&lt;0..2^32-1&gt;;
    optional&lt;UpdatePath&gt; path;
} Commit;
</pre><a href="#section-10.2-3" class="pilcrow">¶</a>
</div>
<p id="section-10.2-4">A group member that has observed one or more proposals within an epoch MUST send
a Commit message before sending application data. This ensures, for example,
that any members whose removal was proposed during the epoch are actually
removed before any application data is transmitted.<a href="#section-10.2-4" class="pilcrow">¶</a></p>
<p id="section-10.2-5">The sender of a Commit MUST include all valid proposals that it has received
during the current epoch. Invalid proposals include, for example, proposals with
an invalid signature or proposals that are semantically invalid, such as an Add
when the sender does not have the application-level permission to add new users.
If there are multiple proposals that apply to the same leaf, the committer
chooses one and includes only that one in the Commit, considering the rest
invalid. The committer MUST prefer any Remove received, or the most recent
Update for the leaf if there are no Removes. If there are multiple Add proposals
for the same client, the committer again chooses one to include and considers
the rest invalid.<a href="#section-10.2-5" class="pilcrow">¶</a></p>
<p id="section-10.2-6">The Commit MUST NOT combine proposals sent within different epochs. In the event
that a valid proposal is omitted from the next Commit, the sender of the
proposal SHOULD retransmit it in the new epoch.<a href="#section-10.2-6" class="pilcrow">¶</a></p>
<p id="section-10.2-7">A member of the group MAY send a Commit that references no proposals at all,
which would thus have an empty <code>proposals</code> vector.  Such
a Commit resets the sender's leaf and the nodes along its direct path, and
provides forward secrecy and post-compromise security with regard to the sender
of the Commit.  An Update proposal can be regarded as a "lazy" version of this
operation, where only the leaf changes and intermediate nodes are blanked out.<a href="#section-10.2-7" class="pilcrow">¶</a></p>
<p id="section-10.2-8">The <code>path</code> field of a Commit message MUST be populated if the Commit covers at
least one Update or Remove proposal. The <code>path</code> field MUST also be populated
if the Commit covers no proposals at all (i.e., if the proposals vector
is empty). The <code>path</code> field MAY be omitted if the Commit covers only Add
proposals.  In pseudocode, the logic for validating a Commit is as follows:<a href="#section-10.2-8" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.2-9">
<pre>
hasUpdates = false
hasRemoves = false

for i, id in commit.proposals:
    proposal = proposalCache[id]
    assert(proposal != null)

    hasUpdates = hasUpdates || proposal.msg_type == update
    hasRemoves = hasRemoves || proposal.msg_type == remove

if len(commit.proposals) == 0 || hasUpdates || hasRemoves:
  assert(commit.path != null)
</pre><a href="#section-10.2-9" class="pilcrow">¶</a>
</div>
<p id="section-10.2-10">To summarize, a Commit can have three different configurations, with different
uses:<a href="#section-10.2-10" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10.2-11">
<li id="section-10.2-11.1">An "empty" Commit that references no proposals, which updates the committer's
contribution to the group and provides PCS with regard to the committer.<a href="#section-10.2-11.1" class="pilcrow">¶</a>
</li>
          <li id="section-10.2-11.2">An "add-only" Commit that references only Add proposals, in which the path is
optional.  Such a commit provides PCS with regard to the committer only if
the path field is present.<a href="#section-10.2-11.2" class="pilcrow">¶</a>
</li>
          <li id="section-10.2-11.3">A "full" Commit that references proposals of any type, which provides FS with
regard to any removed members and PCS for the committer and any updated
members.<a href="#section-10.2-11.3" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-10.2-12">A member of the group creates a Commit message and the corresponding Welcome
message at the same time, by taking the following steps:<a href="#section-10.2-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-13.1">Construct an initial Commit object with the <code>proposals</code>
field populated from Proposals received during the current epoch, and empty
<code>key_package</code> and <code>path</code> fields.<a href="#section-10.2-13.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-13.2">
            <p id="section-10.2-13.2.1">Generate a provisional GroupContext object by applying the proposals
referenced in the initial Commit object, as described in <a href="#proposals" class="xref">Section 10.1</a>. Update
proposals are applied first, followed by Remove proposals, and then finally
Add proposals. Add proposals are applied in the order listed in the
<code>proposals</code> vector, and always to the leftmost unoccupied leaf in the tree, or
the right edge of the tree if all leaves are occupied.<a href="#section-10.2-13.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-13.2.2.1">Note that the order in which different types of proposals are applied should
be updated by the implementation to include any new proposals added by
negotiated group extensions.<a href="#section-10.2-13.2.2.1" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-10.2-13.3">Decide whether to populate the <code>path</code> field: If the <code>path</code> field is required
based on the proposals that are in the commit (see above), then it MUST be
populated.  Otherwise, the sender MAY omit the <code>path</code> field at its discretion.<a href="#section-10.2-13.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-13.4">
            <p id="section-10.2-13.4.1">If populating the <code>path</code> field: Create a UpdatePath using the new tree (which
includes any new members).  The GroupContext for this operation uses the
<code>group_id</code>, <code>epoch</code>, <code>tree_hash</code>, and <code>confirmed_transcript_hash</code> values in
the initial GroupContext object.<a href="#section-10.2-13.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-13.4.2.1">Assign this UpdatePath to the <code>path</code> field in the Commit.<a href="#section-10.2-13.4.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-10.2-13.4.2.2">Apply the UpdatePath to the tree, as described in
<a href="#synchronizing-views-of-the-tree" class="xref">Section 5.5</a>. Define <code>commit_secret</code> as the value
<code>path_secret[n+1]</code> derived from the <code>path_secret[n]</code> value assigned to
the root node.<a href="#section-10.2-13.4.2.2" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-10.2-13.5">If not populating the <code>path</code> field: Set the <code>path</code> field in the Commit to the
null optional.  Define <code>commit_secret</code> as the all-zero vector of the same
length as a <code>path_secret</code> value would be.<a href="#section-10.2-13.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-13.6">Generate a new KeyPackage for the Committer's own leaf, with a
<code>parent_hash</code> extension. Store it in the ratchet tree and assign it to the
<code>key_package</code> field in the Commit object.<a href="#section-10.2-13.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-13.7">Construct an MLSPlaintext object containing the Commit object.  Use the
<code>commit_secret</code> to advance the key schedule and compute the <code>confirmation_tag</code>
value in the MLSPlaintext.  Sign the MLSPlaintext using the current epoch's
GroupContext as context.<a href="#section-10.2-13.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-13.8">Update the tree in the provisional state by applying the direct path<a href="#section-10.2-13.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-13.9">
            <p id="section-10.2-13.9.1">Construct a GroupInfo reflecting the new state:<a href="#section-10.2-13.9.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-13.9.2.1">Group ID, epoch, tree, confirmed transcript hash, and interim transcript
hash from the new state<a href="#section-10.2-13.9.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-10.2-13.9.2.2">The confirmation_tag from the MLSPlaintext object<a href="#section-10.2-13.9.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-10.2-13.9.2.3">Sign the GroupInfo using the member's private signing key<a href="#section-10.2-13.9.2.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-10.2-13.9.2.4">Encrypt the GroupInfo using the key and nonce derived from the <code>joiner_secret</code>
for the new epoch (see <a href="#welcoming-new-members" class="xref">Section 10.2.1</a>)<a href="#section-10.2-13.9.2.4" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-10.2-13.10">
            <p id="section-10.2-13.10.1">For each new member in the group:<a href="#section-10.2-13.10.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-13.10.2.1">Identify the lowest common ancestor in the tree of the new member's
leaf node and the member sending the Commit<a href="#section-10.2-13.10.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-10.2-13.10.2.2">If the <code>path</code> field was populated above: Compute the path secret
corresponding to the common ancestor node<a href="#section-10.2-13.10.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-10.2-13.10.2.3">Compute an EncryptedGroupSecrets object that encapsulates the <code>init_secret</code>
for the current epoch and the path secret (if present).<a href="#section-10.2-13.10.2.3" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-10.2-13.11">Construct a Welcome message from the encrypted GroupInfo object and the
encrypted group secrets.<a href="#section-10.2-13.11" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-10.2-14">A member of the group applies a Commit message by taking the following steps:<a href="#section-10.2-14" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-15.1">Verify that the <code>epoch</code> field of the enclosing MLSPlaintext message is equal
to the <code>epoch</code> field of the current GroupContext object<a href="#section-10.2-15.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-15.2">Verify that the signature on the MLSPlaintext message verifies using the
public key from the credential stored at the leaf in the tree indicated by
the <code>sender</code> field.<a href="#section-10.2-15.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-15.3">
            <p id="section-10.2-15.3.1">Generate a provisional GroupContext object by applying the proposals
referenced in the initial Commit object, as described in <a href="#proposals" class="xref">Section 10.1</a>. Update
proposals are applied first, followed by Remove proposals, and then finally
Add proposals. Add proposals are applied in the order listed in the
<code>proposals</code> vector, and always to the leftmost unoccupied leaf in the tree, or
the right edge of the tree if all leaves are occupied.<a href="#section-10.2-15.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-15.3.2.1">Note that the order in which different types of proposals are applied should
be updated by the implementation to include any new proposals added by
negotiated group extensions.<a href="#section-10.2-15.3.2.1" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-10.2-15.4">Verify that the <code>path</code> value is populated if the <code>proposals</code> vector contains
any Update or Remove proposals, or if it's empty. Otherwise, the <code>path</code> value
MAY be omitted.<a href="#section-10.2-15.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-15.5">
            <p id="section-10.2-15.5.1">If the <code>path</code> value is populated: Process the <code>path</code> value using the ratchet
tree the provisional GroupContext, to update the ratchet tree and generate the
<code>commit_secret</code>:<a href="#section-10.2-15.5.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-15.5.2.1">Apply the UpdatePath to the tree, as described in
<a href="#synchronizing-views-of-the-tree" class="xref">Section 5.5</a>, and store <code>key_package</code> at the
Committer's leaf.<a href="#section-10.2-15.5.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-10.2-15.5.2.2">Verify that the KeyPackage has a <code>parent_hash</code> extension and that its value
matches the new parent of the sender's leaf node.<a href="#section-10.2-15.5.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-10.2-15.5.2.3">Define <code>commit_secret</code> as the value <code>path_secret[n+1]</code> derived from the
<code>path_secret[n]</code> value assigned to the root node.<a href="#section-10.2-15.5.2.3" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-10.2-15.6">If the <code>path</code> value is not populated: Define <code>commit_secret</code> as the all-zero
vector of the same length as a <code>path_secret</code> value would be.<a href="#section-10.2-15.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-15.7">Update the new GroupContext's confirmed and interim transcript hashes using the
new Commit.<a href="#section-10.2-15.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-15.8">Use the <code>commit_secret</code>, the provisional GroupContext, and the init secret from
the previous epoch to compute the epoch secret and derived secrets for the
new epoch.<a href="#section-10.2-15.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-15.9">Use the <code>confirmation_key</code> for the new epoch to compute the confirmation tag
for this message, as described below, and verify that it is the same as the
<code>confirmation_tag</code> field in the MLSPlaintext object.<a href="#section-10.2-15.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-15.10">If the above checks are successful, consider the updated GroupContext object
as the current state of the group.<a href="#section-10.2-15.10" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-10.2-16">The confirmation tag value confirms that the members of the group have arrived at
the same state of the group:<a href="#section-10.2-16" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.2-17">
<pre>
MLSPlaintext.confirmation_tag =
    KDF.Extract(confirmation_key, GroupContext.confirmed_transcript_hash)
</pre><a href="#section-10.2-17" class="pilcrow">¶</a>
</div>
<div id="welcoming-new-members">
<section id="section-10.2.1">
          <h4 id="name-welcoming-new-members">
<a href="#section-10.2.1" class="section-number selfRef">10.2.1. </a><a href="#name-welcoming-new-members" class="section-name selfRef">Welcoming New Members</a>
          </h4>
<p id="section-10.2.1-1">The sender of a Commit message is responsible for sending a Welcome message to
any new members added via Add proposals.  The Welcome message provides the new
members with the current state of the group, after the application of the Commit
message.  The new members will not be able to decrypt or verify the Commit
message, but will have the secrets they need to participate in the epoch
initiated by the Commit message.<a href="#section-10.2.1-1" class="pilcrow">¶</a></p>
<p id="section-10.2.1-2">In order to allow the same Welcome message to be sent to all new members,
information describing the group is encrypted with a symmetric key and nonce
randomly chosen by the sender.  This key and nonce are then encrypted to each
new member using HPKE.  In the same encrypted package, the committer transmits
the path secret for the lowest node contained in the direct paths of both the
committer and the new member.  This allows the new member to compute private
keys for nodes in its direct path that are being reset by the corresponding
Commit.<a href="#section-10.2.1-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.2.1-3">
<pre>
struct {
  opaque group_id&lt;0..255&gt;;
  uint64 epoch;
  opaque tree_hash&lt;0..255&gt;;
  opaque confirmed_transcript_hash&lt;0..255&gt;;
  opaque interim_transcript_hash&lt;0..255&gt;;
  Extension extensions&lt;0..2^32-1&gt;;
  opaque confirmation_tag&lt;0..255&gt;;
  uint32 signer_index;
  opaque signature&lt;0..2^16-1&gt;;
} GroupInfo;

struct {
  opaque path_secret&lt;1..255&gt;;
} PathSecret;

struct {
  opaque joiner_secret&lt;1..255&gt;;
  optional&lt;PathSecret&gt; path_secret;
} GroupSecrets;

struct {
  opaque key_package_hash&lt;1..255&gt;;
  HPKECiphertext encrypted_group_secrets;
} EncryptedGroupSecrets;

struct {
  ProtocolVersion version = mls10;
  CipherSuite cipher_suite;
  EncryptedGroupSecrets secrets&lt;0..2^32-1&gt;;
  opaque encrypted_group_info&lt;1..2^32-1&gt;;
} Welcome;
</pre><a href="#section-10.2.1-3" class="pilcrow">¶</a>
</div>
<p id="section-10.2.1-4">The client processing a Welcome message will need to have a copy of the group's
ratchet tree.  The tree can be provided in the Welcome message, in an extension
of type <code>ratchet_tree</code>.  If it is sent otherwise (e.g., provided by a caching
service on the Delivery Service), then the client MUST download the tree before
processing the Welcome.<a href="#section-10.2.1-4" class="pilcrow">¶</a></p>
<p id="section-10.2.1-5">On receiving a Welcome message, a client processes it using the following steps:<a href="#section-10.2.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2.1-6.1">Identify an entry in the <code>secrets</code> array where the <code>key_package_hash</code>
value corresponds to one of this client's KeyPackages, using the hash
indicated by the <code>cipher_suite</code> field.  If no such field exists, or if the
ciphersuite indicated in the KeyPackage does not match the one in the
Welcome message, return an error.<a href="#section-10.2.1-6.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.2.1-6.2">Decrypt the <code>encrypted_group_secrets</code> using HPKE with the algorithms indicated
by the ciphersuite and the HPKE private key corresponding to the GroupSecrets.<a href="#section-10.2.1-6.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.2.1-6.3">From the <code>joiner_secret</code> in the decrypted GroupSecrets object, derive the
<code>welcome_secret</code>, <code>welcome_key</code>, and <code>welcome_nonce</code>.  Use the key
and nonce to decrypt the <code>encrypted_group_info</code> field.<a href="#section-10.2.1-6.3" class="pilcrow">¶</a>
</li>
          </ul>
<div class="artwork art-text alignLeft" id="section-10.2.1-7">
<pre>
welcome_secret = DeriveSecret(joiner_secret, "welcome")
welcome_nonce = KDF.Expand(welcome_secret, "nonce", nonce_length)
welcome_key = KDF.Expand(welcome_secret, "key", key_length)
</pre><a href="#section-10.2.1-7" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-10.2.1-8.1">Verify the signature on the GroupInfo object.  The signature input comprises
all of the fields in the GroupInfo object except the signature field.  The
public key and algorithm are taken from the credential in the leaf node at
position <code>signer_index</code>.  If this verification fails, return an error.<a href="#section-10.2.1-8.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.2.1-8.2">
              <p id="section-10.2.1-8.2.1">Verify the integrity of the ratchet tree.<a href="#section-10.2.1-8.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2.1-8.2.2.1">Verify that the tree hash of the ratchet tree matches the <code>tree_hash</code> field
in the GroupInfo.<a href="#section-10.2.1-8.2.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-10.2.1-8.2.2.2">For each non-empty parent node, verify that exactly one of the node's
children are non-empty and have the hash of this node set as their
<code>parent_hash</code> value (if the child is another parent) or has a <code>parent_hash</code>
extension in the KeyPackage containing the same value (if the child is a
leaf).<a href="#section-10.2.1-8.2.2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-10.2.1-8.2.2.3">For each non-empty leaf node, verify the signature on the KeyPackage.<a href="#section-10.2.1-8.2.2.3" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-10.2.1-8.3">Identify a leaf in the <code>tree</code> array (any even-numbered node) whose
<code>key_package</code> field is identical to the the KeyPackage.  If no such field
exists, return an error.  Let <code>index</code> represent the index of this node among
the leaves in the tree, namely the index of the node in the <code>tree</code> array
divided by two.<a href="#section-10.2.1-8.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.2.1-8.4">
              <p id="section-10.2.1-8.4.1">Construct a new group state using the information in the GroupInfo object.
The new member's position in the tree is <code>index</code>, as defined above.  In
particular, the confirmed transcript hash for the new state is the
<code>prior_confirmed_transcript_hash</code> in the GroupInfo object.<a href="#section-10.2.1-8.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2.1-8.4.2.1">Update the leaf at index <code>index</code> with the private key corresponding to the
public key in the node.<a href="#section-10.2.1-8.4.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-10.2.1-8.4.2.2">If the <code>path_secret</code> value is set in the GroupSecrets object: Identify the
lowest common ancestor of the leaves at <code>index</code> and at
<code>GroupInfo.signer_index</code>.  Set the private key for this node to the
private key derived from the <code>path_secret</code>.<a href="#section-10.2.1-8.4.2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-10.2.1-8.4.2.3">For each parent of the common ancestor, up to the root of the tree, derive
a new path secret and set the private key for the node to the private key
derived from the path secret.  The private key MUST be the private key
that corresponds to the public key in the node.<a href="#section-10.2.1-8.4.2.3" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-10.2.1-8.5">Use the <code>joiner_secret</code> from the GroupSecrets object to generate the epoch secret
and other derived secrets for the current epoch.<a href="#section-10.2.1-8.5" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.2.1-8.6">Set the confirmed transcript hash in the new state to the value of the
<code>confirmed_transcript_hash</code> in the GroupInfo.<a href="#section-10.2.1-8.6" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-10.2.1-8.7">Verify the confirmation tag in the GroupInfo using the derived confirmation
key and the <code>confirmed_transcript_hash</code> from the GroupInfo.<a href="#section-10.2.1-8.7" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
</section>
</div>
<div id="ratchet-tree-extension">
<section id="section-10.3">
        <h3 id="name-ratchet-tree-extension">
<a href="#section-10.3" class="section-number selfRef">10.3. </a><a href="#name-ratchet-tree-extension" class="section-name selfRef">Ratchet Tree Extension</a>
        </h3>
<p id="section-10.3-1">By default, a GroupInfo message only provides the joiner with a commitment
to the group's ratchet tree.  In order to process or generate handshake
messages, the joiner will need to get a copy of the ratchet tree from some other
source.  (For example, the DS might provide a cached copy.)  The inclusion of
the tree hash in the GroupInfo message means that the source of the ratchet
tree need not be trusted to maintain the integrity of tree.<a href="#section-10.3-1" class="pilcrow">¶</a></p>
<p id="section-10.3-2">In cases where the application does not wish to provide such an external source,
the whole public state of the ratchet tree can be provided in an extension of
type <code>ratchet_tree</code>, containing a <code>ratchet_tree</code> object of the following form:<a href="#section-10.3-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-10.3-3">
<pre>
enum {
    reserved(0),
    leaf(1),
    parent(2),
    (255)
} NodeType;

struct {
    NodeType node_type;
    select (Node.node_type) {
        case leaf:   KeyPackage key_package;
        case parent: ParentNode node;
    };
} Node;

optional&lt;Node&gt; ratchet_tree&lt;1..2^32-1&gt;;
</pre><a href="#section-10.3-3" class="pilcrow">¶</a>
</div>
<p id="section-10.3-4">The presence of a <code>ratchet_tree</code> extension in a GroupInfo message does not
result in any changes to the GroupContext extensions for the group.  The ratchet
tree provided is simply stored by the client and used for MLS operations.<a href="#section-10.3-4" class="pilcrow">¶</a></p>
<p id="section-10.3-5">If this extension is not provided in a Welcome message, then the client will
need to fetch the ratchet tree over some other channel before it can generate or
process Commit messages.  Applications should ensure that this out-of-band
channel is provided with security protections equivalent to the protections that
are afforded to Proposal and Commit messages.  For example, an application that
encrypts Proposal and Commit messages might distribute ratchet trees encrypted
using a key exchanged over the MLS channel.<a href="#section-10.3-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="extensibility">
<section id="section-11">
      <h2 id="name-extensibility">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-extensibility" class="section-name selfRef">Extensibility</a>
      </h2>
<p id="section-11-1">This protocol includes a mechanism for negotiating extension parameters similar
to the one in TLS <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.  In TLS, extension negotiation is one-to-one: The
client offers extensions in its ClientHello message, and the server expresses
its choices for the session with extensions in its ServerHello and
EncryptedExtensions messages.  In MLS, extensions appear in the following
places:<a href="#section-11-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-11-2.1">In KeyPackages, to describe client capabilities and aspects of their
participation in the group (once in the ratchet tree)<a href="#section-11-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-11-2.2">In the Welcome message, to tell new members of a group what parameters are
being used by the group<a href="#section-11-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-11-2.3">In the GroupContext object, to ensure that all members of the group have the
same view of the parameters in use<a href="#section-11-2.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-11-3">In other words, clients advertise their capabilities in KeyPackage
extensions, the creator of the group expresses its choices for the group in
Welcome extensions, and the GroupContext confirms that all members of the group
have the same view of the group's extensions.<a href="#section-11-3" class="pilcrow">¶</a></p>
<p id="section-11-4">This extension mechanism is designed to allow for secure and forward-compatible
negotiation of extensions.  For this to work, implementations MUST correctly
handle extensible fields:<a href="#section-11-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-11-5.1">A client that posts a KeyPackage MUST support all parameters advertised in
it.  Otherwise, another client might fail to interoperate by selecting one of
those parameters.<a href="#section-11-5.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-11-5.2">A client initiating a group MUST ignore all unrecognized ciphersuites,
extensions, and other parameters.  Otherwise, it may fail to interoperate with
newer clients.<a href="#section-11-5.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-11-5.3">A client adding a new member to a group MUST verify that the KeyPackage
for the new member contains extensions that are consistent with the group's
extensions.  For each extension in the GroupContext, the KeyPackage MUST
have an extension of the same type, and the contents of the extension MUST be
consistent with the value of the extension in the GroupContext, according to
the semantics of the specific extension.<a href="#section-11-5.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-11-5.4">If any extension in a GroupInfo message is unrecognized (i.e., not contained
in the corresponding KeyPackage), then the client MUST reject the Welcome
message and not join the group.<a href="#section-11-5.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-11-5.5">The extensions populated into a GroupContext object are drawn from those in
the GroupInfo object, according to the definitions of those extensions.<a href="#section-11-5.5" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-11-6">Note that the latter two requirements mean that all MLS extensions are
mandatory, in the sense that an extension in use by the group MUST be supported
by all members of the group.<a href="#section-11-6" class="pilcrow">¶</a></p>
<p id="section-11-7">This document does not define any way for the parameters of the group to change
once it has been created; such a behavior could be implemented as an extension.<a href="#section-11-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sequencing">
<section id="section-12">
      <h2 id="name-sequencing-of-state-changes">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-sequencing-of-state-changes" class="section-name selfRef">Sequencing of State Changes</a>
      </h2>
<p id="section-12-1">Each Commit message is premised on a given starting state,
indicated by the <code>epoch</code> field of the enclosing MLSPlaintext
message. If the changes implied by a Commit messages are made
starting from a different state, the results will be incorrect.<a href="#section-12-1" class="pilcrow">¶</a></p>
<p id="section-12-2">This need for sequencing is not a problem as long as each time a
group member sends a Commit message, it is based on the most
current state of the group.  In practice, however, there is a risk
that two members will generate Commit messages simultaneously,
based on the same state.<a href="#section-12-2" class="pilcrow">¶</a></p>
<p id="section-12-3">When this happens, there is a need for the members of the group to
deconflict the simultaneous Commit messages.  There are two
general approaches:<a href="#section-12-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12-4.1">Have the delivery service enforce a total order<a href="#section-12-4.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-12-4.2">Have a signal in the message that clients can use to break ties<a href="#section-12-4.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-12-5">As long as Commit messages cannot be merged, there is a risk of
starvation.  In a sufficiently busy group, a given member may never
be able to send a Commit message, because he always loses to other
members.  The degree to which this is a practical problem will depend
on the dynamics of the application.<a href="#section-12-5" class="pilcrow">¶</a></p>
<p id="section-12-6">It might be possible, because of the non-contributivity of intermediate
nodes, that Commit messages could be applied one after the other
without the Delivery Service having to reject any Commit message,
which would make MLS more resilient regarding the concurrency of
Commit messages.
The Messaging system can decide to choose the order for applying
the state changes. Note that there are certain cases (if no total
ordering is applied by the Delivery Service) where the ordering is
important for security, ie. all updates must be executed before
removes.<a href="#section-12-6" class="pilcrow">¶</a></p>
<p id="section-12-7">Regardless of how messages are kept in sequence, implementations
MUST only update their cryptographic state when valid Commit
messages are received.
Generation of Commit messages MUST NOT modify a client's state, since the
endpoint doesn't know at that time whether the changes implied by
the Commit message will succeed or not.<a href="#section-12-7" class="pilcrow">¶</a></p>
<div id="server-enforced-ordering">
<section id="section-12.1">
        <h3 id="name-server-enforced-ordering">
<a href="#section-12.1" class="section-number selfRef">12.1. </a><a href="#name-server-enforced-ordering" class="section-name selfRef">Server-Enforced Ordering</a>
        </h3>
<p id="section-12.1-1">With this approach, the delivery service ensures that incoming
messages are added to an ordered queue and outgoing messages are
dispatched in the same order. The server is trusted to break ties
when two members send a Commit message at the same time.<a href="#section-12.1-1" class="pilcrow">¶</a></p>
<p id="section-12.1-2">Messages should have a counter field sent in clear-text that can
be checked by the server and used for tie-breaking. The counter
starts at 0 and is incremented for every new incoming message.
If two group members send a message with the same counter, the
first message to arrive will be accepted by the server and the
second one will be rejected. The rejected message needs to be sent
again with the correct counter number.<a href="#section-12.1-2" class="pilcrow">¶</a></p>
<p id="section-12.1-3">To prevent counter manipulation by the server, the counter's
integrity can be ensured by including the counter in a signed
message envelope.<a href="#section-12.1-3" class="pilcrow">¶</a></p>
<p id="section-12.1-4">This applies to all messages, not only state changing messages.<a href="#section-12.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="client-enforced-ordering">
<section id="section-12.2">
        <h3 id="name-client-enforced-ordering">
<a href="#section-12.2" class="section-number selfRef">12.2. </a><a href="#name-client-enforced-ordering" class="section-name selfRef">Client-Enforced Ordering</a>
        </h3>
<p id="section-12.2-1">Order enforcement can be implemented on the client as well,
one way to achieve it is to use a two step update protocol: the
first client sends a proposal to update and the proposal is
accepted when it gets 50%+ approval from the rest of the group,
then it sends the approved update. Clients which didn't get
their proposal accepted, will wait for the winner to send their
update before retrying new proposals.<a href="#section-12.2-1" class="pilcrow">¶</a></p>
<p id="section-12.2-2">While this seems safer as it doesn't rely on the server, it is
more complex and harder to implement. It also could cause starvation
for some clients if they keep failing to get their proposal accepted.<a href="#section-12.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="application-messages">
<section id="section-13">
      <h2 id="name-application-messages">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-application-messages" class="section-name selfRef">Application Messages</a>
      </h2>
<p id="section-13-1">The primary purpose of the Handshake protocol is to provide an
authenticated group key exchange to clients. In order to protect
Application messages sent among the members of a group, the Application
secret provided by the Handshake key schedule is used to derive nonces
and encryption keys for the Message Protection Layer according to
the Application Key Schedule. That is, each epoch is equipped with
a fresh Application Key Schedule which consist of a tree of Application
Secrets as well as one symmetric ratchet per group member.<a href="#section-13-1" class="pilcrow">¶</a></p>
<p id="section-13-2">Each client maintains their own local copy of the Application Key
Schedule for each epoch during which they are a group member. They
derive new keys, nonces and secrets as needed while deleting old
ones as soon as they have been used.<a href="#section-13-2" class="pilcrow">¶</a></p>
<p id="section-13-3">Application messages MUST be protected with the Authenticated-Encryption
with Associated-Data (AEAD) encryption scheme associated with the
MLS ciphersuite using the common framing mechanism.
Note that "Authenticated" in this context does not mean messages are
known to be sent by a specific client but only from a legitimate
member of the group.
To authenticate a message from a particular member, signatures are
required. Handshake messages MUST use asymmetric signatures to strongly
authenticate the sender of a message.<a href="#section-13-3" class="pilcrow">¶</a></p>
<div id="astree">
<section id="section-13.1">
        <h3 id="name-tree-of-application-secrets">
<a href="#section-13.1" class="section-number selfRef">13.1. </a><a href="#name-tree-of-application-secrets" class="section-name selfRef">Tree of Application Secrets</a>
        </h3>
<p id="section-13.1-1">The application key schedule begins with the application secrets which
are arranged in an "Application Secret Tree" or AS Tree for short;
a left balanced binary tree with the same set of nodes and edges as
the epoch's ratchet tree. Each leaf in the AS Tree is associated with
the same group member as the corresponding leaf in the ratchet tree.
Nodes are also assigned an index according to their position in the
array representation of the tree (described in <a href="#tree-math" class="xref">Appendix A</a>). If N
is a node index in the AS Tree then left(N) and right(N) denote the
children of N (if they exist).<a href="#section-13.1-1" class="pilcrow">¶</a></p>
<p id="section-13.1-2">Each node in the tree is assigned a secret. The root's secret is simply
the application_secret of that epoch. (See <a href="#key-schedule" class="xref">Section 7.8</a> for the
definition of application_secret.)<a href="#section-13.1-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-13.1-3">
<pre>
astree_node_[root]_secret = application_secret
</pre><a href="#section-13.1-3" class="pilcrow">¶</a>
</div>
<p id="section-13.1-4">The secret of any other node in the tree is derived from its parent's secret
using a call to DeriveAppSecret.<a href="#section-13.1-4" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-13.1-5">
<pre>
DeriveAppSecret(Secret, Label, Node, Generation, Length) =
    ExpandWithLabel(Secret, Label, ApplicationContext, Length)

Where ApplicationContext is specified as:

struct {
    uint32 node = Node;
    uint32 generation = Generation;
} ApplicationContext;
</pre><a href="#section-13.1-5" class="pilcrow">¶</a>
</div>
<p id="section-13.1-6">If N is a node index in the AS Tree then the secrets of the children
of N are defined to be:<a href="#section-13.1-6" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-13.1-7">
<pre>
astree_node_[N]_secret
        |
        |
        +--&gt; DeriveAppSecret(., "tree", left(N), 0, Hash.length)
        |    = astree_node_[left(N)]_secret
        |
        +--&gt; DeriveAppSecret(., "tree", right(N), 0, Hash.length)
             = astree_node_[right(N)]_secret
</pre><a href="#section-13.1-7" class="pilcrow">¶</a>
</div>
<p id="section-13.1-8">Note that fixing concrete values for GroupContext_[n] and application_secret
completely defines all secrets in the AS Tree.<a href="#section-13.1-8" class="pilcrow">¶</a></p>
<p id="section-13.1-9">The secret in the leaf of the AS tree is used to initiate a symmetric hash
ratchet, from which a sequence of single-use keys and nonces are derived, as
described in <a href="#encryption-keys" class="xref">Section 7.10</a>.<a href="#section-13.1-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="deletion-schedule">
<section id="section-13.2">
        <h3 id="name-deletion-schedule">
<a href="#section-13.2" class="section-number selfRef">13.2. </a><a href="#name-deletion-schedule" class="section-name selfRef">Deletion Schedule</a>
        </h3>
<p id="section-13.2-1">It is important to delete all security sensitive values as soon as they are
<em>consumed</em>. A sensitive value S is said to be <em>consumed</em> if<a href="#section-13.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2-2.1">S was used to encrypt or (successfully) decrypt a message, or if<a href="#section-13.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-13.2-2.2">a key, nonce, or secret derived from S has been consumed. (This goes for
values derived via DeriveSecret as well as ExpandWithLabel.)<a href="#section-13.2-2.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-13.2-3">Here, S may be the <code>init_secret</code>, <code>commit_secret</code>, <code>epoch_secret</code>, <code>application_secret</code>
as well as any secret in the AS Tree or one of the ratchets.<a href="#section-13.2-3" class="pilcrow">¶</a></p>
<p id="section-13.2-4">As soon as a group member consumes a value they MUST immediately delete
(all representations of) that value. This is crucial to ensuring
forward secrecy for past messages. Members MAY keep unconsumed values around
for some reasonable amount of time to handle out-of-order message delivery.<a href="#section-13.2-4" class="pilcrow">¶</a></p>
<p id="section-13.2-5">For example, suppose a group member encrypts or (successfully) decrypts a
message using the j-th key and nonce in the i-th ratchet. Then, for that
member, at least the following values have been consumed and MUST be deleted:<a href="#section-13.2-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2-6.1">the <code>init_secret</code>, <code>commit_secret</code>, <code>epoch_secret</code>, <code>application_secret</code> of that
epoch,<a href="#section-13.2-6.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-13.2-6.2">all node secrets in the AS Tree on the path from the root to the leaf with
index i,<a href="#section-13.2-6.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-13.2-6.3">the first j secrets in the i-th ratchet and<a href="#section-13.2-6.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-13.2-6.4">
            <code>application_[i]_[j]_key</code> and <code>application_[i]_[j]_nonce</code>.<a href="#section-13.2-6.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-13.2-7">Concretely, suppose we have the following AS Tree and ratchet for
participant D:<a href="#section-13.2-7" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-13.2-8">
<pre>
       G
     /   \
    /     \
   E       F
  / \     / \
A0  B0  C0  D0 -+- KD0
            |   |
            |   +- ND0
            |
            D1 -+- KD1
            |   |
            |   +- ND1
            |
            D2
</pre><a href="#section-13.2-8" class="pilcrow">¶</a>
</div>
<p id="section-13.2-9">Then if a client uses key KD1 and nonce ND1 during epoch n then it must consume
(at least) values G, F, D0, D1, KD1, ND1 as well as the <code>commit_secret</code> and
init_secret used to derive G (the application_secret).  The
client MAY retain (not consume) the values KD0 and ND0 to
allow for out-of-order delivery, and SHOULD retain D2 to allow for
processing future messages.<a href="#section-13.2-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="further-restrictions">
<section id="section-13.3">
        <h3 id="name-further-restrictions">
<a href="#section-13.3" class="section-number selfRef">13.3. </a><a href="#name-further-restrictions" class="section-name selfRef">Further Restrictions</a>
        </h3>
<p id="section-13.3-1">During each epoch senders MUST NOT encrypt more data than permitted by the
security bounds of the AEAD scheme used.<a href="#section-13.3-1" class="pilcrow">¶</a></p>
<p id="section-13.3-2">Note that each change to the Group through a Handshake message will also set a
new application_secret. Hence this change MUST be applied before encrypting
any new Application message. This is required both to ensure that any users
removed from the group can no longer receive messages and to (potentially)
recover confidentiality and authenticity for future messages despite a past
state compromise.<a href="#section-13.3-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="message-encryption-and-decryption">
<section id="section-13.4">
        <h3 id="name-message-encryption-and-decr">
<a href="#section-13.4" class="section-number selfRef">13.4. </a><a href="#name-message-encryption-and-decr" class="section-name selfRef">Message Encryption and Decryption</a>
        </h3>
<p id="section-13.4-1">The group members MUST use the AEAD algorithm associated with
the negotiated MLS ciphersuite to AEAD encrypt and decrypt their
Application messages according to the Message Framing section.<a href="#section-13.4-1" class="pilcrow">¶</a></p>
<p id="section-13.4-2">The group identifier and epoch allow a recipient to know which group secrets
should be used and from which Epoch secret to start computing other secrets
and keys. The sender identifier is used to identify the member's
symmetric ratchet from the initial group Application secret. The application
generation field is used to determine how far into the ratchet to iterate in
order to reproduce the required AEAD keys and nonce for performing decryption.<a href="#section-13.4-2" class="pilcrow">¶</a></p>
<p id="section-13.4-3">Application messages SHOULD be padded to provide some resistance
against traffic analysis techniques over encrypted traffic.
<span>[<a href="#CLINIC" class="xref">CLINIC</a>]</span>
          <span>[<a href="#HCJ16" class="xref">HCJ16</a>]</span>
While MLS might deliver the same payload less frequently across
a lot of ciphertexts than traditional web servers, it might still provide
the attacker enough information to mount an attack. If Alice asks Bob:
"When are we going to the movie ?" the answer "Wednesday" might be leaked
to an adversary by the ciphertext length. An attacker expecting Alice to
answer Bob with a day of the week might find out the plaintext by
correlation between the question and the length.<a href="#section-13.4-3" class="pilcrow">¶</a></p>
<p id="section-13.4-4">Similarly to TLS 1.3, if padding is used, the MLS messages MUST be
padded with zero-valued bytes before AEAD encryption. Upon AEAD decryption,
the length field of the plaintext is used to compute the number of bytes
to be removed from the plaintext to get the correct data.
As the padding mechanism is used to improve protection against traffic
analysis, removal of the padding SHOULD be implemented in a "constant-time"
manner at the MLS layer and above layers to prevent timing side-channels that
would provide attackers with information on the size of the plaintext.
The padding length length_of_padding can be chosen at the time of the message
encryption by the sender. Recipients can calculate the padding size from knowing
the total size of the ApplicationPlaintext and the length of the content.<a href="#section-13.4-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="delayed-and-reordered-application-messages">
<section id="section-13.5">
        <h3 id="name-delayed-and-reordered-appli">
<a href="#section-13.5" class="section-number selfRef">13.5. </a><a href="#name-delayed-and-reordered-appli" class="section-name selfRef">Delayed and Reordered Application messages</a>
        </h3>
<p id="section-13.5-1">Since each Application message contains the group identifier, the epoch and a
message counter, a client can receive messages out of order.
If they are able to retrieve or recompute the correct AEAD decryption key
from currently stored cryptographic material clients can decrypt
these messages.<a href="#section-13.5-1" class="pilcrow">¶</a></p>
<p id="section-13.5-2">For usability, MLS clients might be required to keep the AEAD key
and nonce for a certain amount of time to retain the ability to decrypt
delayed or out of order messages, possibly still in transit while a
decryption is being done.<a href="#section-13.5-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-14">
      <h2 id="name-security-considerations">
<a href="#section-14" class="section-number selfRef">14. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-14-1">The security goals of MLS are described in <span>[<a href="#I-D.ietf-mls-architecture" class="xref">I-D.ietf-mls-architecture</a>]</span>.
We describe here how the protocol achieves its goals at a high level,
though a complete security analysis is outside of the scope of this
document.<a href="#section-14-1" class="pilcrow">¶</a></p>
<div id="confidentiality-of-the-group-secrets">
<section id="section-14.1">
        <h3 id="name-confidentiality-of-the-grou">
<a href="#section-14.1" class="section-number selfRef">14.1. </a><a href="#name-confidentiality-of-the-grou" class="section-name selfRef">Confidentiality of the Group Secrets</a>
        </h3>
<p id="section-14.1-1">Group secrets are derived from (i) previous group secrets, and (ii)
the root key of a ratcheting tree. Only group members know their leaf
private key in the group, therefore, the root key of the group's ratcheting
tree is secret and thus so are all values derived from it.<a href="#section-14.1-1" class="pilcrow">¶</a></p>
<p id="section-14.1-2">Initial leaf keys are known only by their owner and the group creator,
because they are derived from an authenticated key exchange protocol.
Subsequent leaf keys are known only by their owner.<a href="#section-14.1-2" class="pilcrow">¶</a></p>
<p id="section-14.1-3">Note that the long-term identity keys used by the protocol MUST be
distributed by an "honest" authentication service for clients to
authenticate their legitimate peers.<a href="#section-14.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authentication">
<section id="section-14.2">
        <h3 id="name-authentication">
<a href="#section-14.2" class="section-number selfRef">14.2. </a><a href="#name-authentication" class="section-name selfRef">Authentication</a>
        </h3>
<p id="section-14.2-1">There are two forms of authentication we consider. The first form
considers authentication with respect to the group. That is, the group
members can verify that a message originated from one of the members
of the group. This is implicitly guaranteed by the secrecy of the
shared key derived from the ratcheting trees: if all members of the
group are honest, then the shared group key is only known to the group
members. By using AEAD or appropriate MAC with this shared key, we can
guarantee that a member in the group (who knows the shared secret
key) has sent a message.<a href="#section-14.2-1" class="pilcrow">¶</a></p>
<p id="section-14.2-2">The second form considers authentication with respect to the sender,
meaning the group members can verify that a message originated from a
particular member of the group. This property is provided by digital
signatures on the messages under identity keys.<a href="#section-14.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="forward-and-post-compromise-security">
<section id="section-14.3">
        <h3 id="name-forward-and-post-compromise">
<a href="#section-14.3" class="section-number selfRef">14.3. </a><a href="#name-forward-and-post-compromise" class="section-name selfRef">Forward and post-compromise security</a>
        </h3>
<p id="section-14.3-1">Message encryption keys are derived via a hash ratchet, which
provides a form of forward secrecy: learning a message key does not
reveal previous message or root keys. Post-compromise security is
provided by Commit operations, in which a new root key is generated
from the latest ratcheting tree. If the adversary cannot derive the
updated root key after an Commit operation, it cannot compute any
derived secrets.<a href="#section-14.3-1" class="pilcrow">¶</a></p>
<p id="section-14.3-2">In the case where the client could have been compromised (device
loss, for example), the client SHOULD signal the delivery service to expire
all the previous KeyPackages and publish fresh ones for PCS.<a href="#section-14.3-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="initkey-reuse">
<section id="section-14.4">
        <h3 id="name-initkey-reuse">
<a href="#section-14.4" class="section-number selfRef">14.4. </a><a href="#name-initkey-reuse" class="section-name selfRef">InitKey Reuse</a>
        </h3>
<p id="section-14.4-1">InitKeys are intended to be used only once.  That is, once an InitKey has been
used to introduce the corresponding client to a group, it SHOULD be deleted from
the InitKey publication system.  Reuse of InitKeys can lead to replay attacks.<a href="#section-14.4-1" class="pilcrow">¶</a></p>
<p id="section-14.4-2">An application MAY allow for reuse of a "last resort" InitKey in order to
prevent denial of service attacks.  Since an InitKey is needed to add a client
to a new group, an attacker could prevent a client being added to new groups by
exhausting all available InitKeys.<a href="#section-14.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="improving-randomness-of-secrets">
<section id="section-14.5">
        <h3 id="name-improving-randomness-of-sec">
<a href="#section-14.5" class="section-number selfRef">14.5. </a><a href="#name-improving-randomness-of-sec" class="section-name selfRef">Improving Randomness of Secrets</a>
        </h3>
<p id="section-14.5-1">The security of a group hinges on the fact that every member has access to a
good source of entropy. To make the protocol more robust in environments with
weak sources of entropy or even compromised random number generators, each MLS
implementation MUST maintain an <code>entropy_pool_secret</code>. The <code>entropy_pool_secret</code>
serves as a source of entropy, which is used to derive fresh secrets whenever
needed, for example when generating a new KeyPackage for an Update operation.<a href="#section-14.5-1" class="pilcrow">¶</a></p>
<p id="section-14.5-2">To ensure that Post-Compromise Security (PCS) can be achieved, the
<code>entropy_pool_secret</code> must be injected with fresh entropy from some other
source, such as the Random Number Generator (RNG) of the operating system.<a href="#section-14.5-2" class="pilcrow">¶</a></p>
<p id="section-14.5-3">To achieve Forward Secrecy, the <code>entropy_pool_secret</code> is additionally "ratcheted
forward" after each extraction of a fresh secret.<a href="#section-14.5-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-14.5-4">
<pre>
             entropy_pool_secret_[n-1]
                        |
                        V
fresh_randomness -&gt; KDF.Extract = intermediate_secret
                        |
                        +--&gt; DeriveSecret(., "mls_secret")
                        |    = fresh_secret
                        |
                        V
                  DeriveSecret(., "entropy_pool_secret")
                  = entropy_pool_secret_[n]
</pre><a href="#section-14.5-4" class="pilcrow">¶</a>
</div>
<p id="section-14.5-5">The entropy gathered in the <code>entropy_pool_secret</code>, can be further increased by
injecting addtional entropy whenever a group is updated by another party.<a href="#section-14.5-5" class="pilcrow">¶</a></p>
<p id="section-14.5-6">If that is the case, the each party that did not perform the update operation
themselves can update their <code>entropy_pool_secret</code> by injecting a secret derived
from the updated group's key schedule. To that end, they first derive an
<code>external_secret</code> as follows, where <code>epoch_secret</code> is the taken from the group's
key schedule and <code>leaf_id</code> is the index of the party's leaf in the group:<a href="#section-14.5-6" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-14.5-7">
<pre>
external_secret =
    ExpandWithLabel(`epoch_secret`, "entropy_pool_update", leaf_id, KDF.Nh)
</pre><a href="#section-14.5-7" class="pilcrow">¶</a>
</div>
<p id="section-14.5-8">The resulting <code>external_secret</code> can then be injected into the entropy pool as follows.
~~~~~
             entropy_pool_secret_[n-1]
                        |
                        V
external_secret -&gt; KDF.Extract = intermediate_secret
                        |
                        V
                  DeriveSecret(., "entropy_pool_secret")
                  = entropy_pool_secret_[n]
~~~~~<a href="#section-14.5-8" class="pilcrow">¶</a></p>
<p id="section-14.5-9">Even though each group member can derive the <code>external_secret</code> for every other
member of the group, the resulting <code>entropy_pool_secret_[n]</code> is still secure as
long as the preceding <code>entropy_pool_secret_[n-1]</code> was secure. As a consequence,
this operation strictly improves the quality of the gathered entropy.<a href="#section-14.5-9" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-15">
      <h2 id="name-iana-considerations">
<a href="#section-15" class="section-number selfRef">15. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-15-1">This document requests the creation of the following new IANA registries:<a href="#section-15-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-15-2.1">MLS Ciphersuites (<a href="#mls-ciphersuites" class="xref">Section 15.1</a>)<a href="#section-15-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-15-2.2">MLS Extension Types (<a href="#mls-extension-types" class="xref">Section 15.2</a>)<a href="#section-15-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-15-2.3">MLS Credential Types (<a href="#mls-credential-types" class="xref">Section 15.3</a>)<a href="#section-15-2.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-15-3">All of these registries should be under a heading of "Messaging Layer Security",
and assignments are made via the Specification Required policy <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>. See
<a href="#de" class="xref">Section 15.4</a> for additional information about the MLS Designated Experts (DEs).<a href="#section-15-3" class="pilcrow">¶</a></p>
<p id="section-15-4">RFC EDITOR: Please replace XXXX throughout with the RFC number assigned to
this document<a href="#section-15-4" class="pilcrow">¶</a></p>
<div id="mls-ciphersuites">
<section id="section-15.1">
        <h3 id="name-mls-ciphersuites">
<a href="#section-15.1" class="section-number selfRef">15.1. </a><a href="#name-mls-ciphersuites" class="section-name selfRef">MLS Ciphersuites</a>
        </h3>
<p id="section-15.1-1">A ciphersuite is a combination of a protocol version and the set of
cryptographic algorithms that should be used.<a href="#section-15.1-1" class="pilcrow">¶</a></p>
<p id="section-15.1-2">Ciphersuite names follow the naming convention:<a href="#section-15.1-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-15.1-3">
<pre>
CipherSuite MLS_LVL_KEM_AEAD_HASH_SIG = VALUE;
</pre><a href="#section-15.1-3" class="pilcrow">¶</a>
</div>
<p id="section-15.1-4">Where VALUE is represented as a sixteen-bit integer:<a href="#section-15.1-4" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-15.1-5">
<pre>
uint16 CipherSuite;
</pre><a href="#section-15.1-5" class="pilcrow">¶</a>
</div>
<table class="center" id="table-3">
          <caption><a href="#table-3" class="selfRef">Table 3</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Component</th>
              <th class="text-left" rowspan="1" colspan="1">Contents</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">MLS</td>
              <td class="text-left" rowspan="1" colspan="1">The string "MLS" followed by the major and minor version, e.g. "MLS10"</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">LVL</td>
              <td class="text-left" rowspan="1" colspan="1">The security level</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">KEM</td>
              <td class="text-left" rowspan="1" colspan="1">The KEM algorithm used for HPKE in TreeKEM group operations</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">AEAD</td>
              <td class="text-left" rowspan="1" colspan="1">The AEAD algorithm used for HPKE and message protection</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">HASH</td>
              <td class="text-left" rowspan="1" colspan="1">The hash algorithm used for HPKE and the MLS transcript hash</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">SIG</td>
              <td class="text-left" rowspan="1" colspan="1">The Signature algorithm used for message authentication</td>
            </tr>
          </tbody>
        </table>
<p id="section-15.1-7">The columns in the registry are as follows:<a href="#section-15.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-15.1-8.1">Value: The numeric value of the ciphersuite<a href="#section-15.1-8.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.1-8.2">Name: The name of the ciphersuite<a href="#section-15.1-8.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.1-8.3">Recommended: Whether support for this extension is recommended by the IETF MLS
WG.  Valid values are "Y" and "N".  The "Recommended" column is assigned a
value of "N" unless explicitly requested, and adding a value with a
"Recommended" value of "Y" requires Standards Action <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>.  IESG Approval
is REQUIRED for a Y-&gt;N transition.<a href="#section-15.1-8.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.1-8.4">Reference: The document where this ciphersuite is defined<a href="#section-15.1-8.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-15.1-9">Initial contents:<a href="#section-15.1-9" class="pilcrow">¶</a></p>
<table class="center" id="table-4">
          <caption><a href="#table-4" class="selfRef">Table 4</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">Name</th>
              <th class="text-left" rowspan="1" colspan="1">Recommended</th>
              <th class="text-left" rowspan="1" colspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0000</td>
              <td class="text-left" rowspan="1" colspan="1">RESERVED</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">MLS10_128_DHKEMX25519_AES128GCM_SHA256_Ed25519</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">MLS10_128_DHKEMP256_AES128GCM_SHA256_P256</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">MLS10_128_DHKEMX25519_CHACHA20POLY1305_SHA256_Ed25519</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0004</td>
              <td class="text-left" rowspan="1" colspan="1">MLS10_256_DHKEMX448_AES256GCM_SHA512_Ed448</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0005</td>
              <td class="text-left" rowspan="1" colspan="1">MLS10_256_DHKEMP521_AES256GCM_SHA512_P521</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0006</td>
              <td class="text-left" rowspan="1" colspan="1">MLS10_256_DHKEMX448_CHACHA20POLY1305_SHA512_Ed448</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0xff00  - 0xffff</td>
              <td class="text-left" rowspan="1" colspan="1">Reserved for Private Use</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
          </tbody>
        </table>
<p id="section-15.1-11">These ciphersuites map to HPKE primitives and TLS signature schemes as follows
<span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span> <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>:<a href="#section-15.1-11" class="pilcrow">¶</a></p>
<table class="center" id="table-5">
          <caption><a href="#table-5" class="selfRef">Table 5</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">KEM</th>
              <th class="text-left" rowspan="1" colspan="1">KDF</th>
              <th class="text-left" rowspan="1" colspan="1">AEAD</th>
              <th class="text-left" rowspan="1" colspan="1">Signature</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">0x0020</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">ed25519</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">0x0010</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">ecdsa_secp256r1_sha256</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">0x0020</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">ed25519</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0004</td>
              <td class="text-left" rowspan="1" colspan="1">0x0021</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">ed448</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0005</td>
              <td class="text-left" rowspan="1" colspan="1">0x0012</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">ecdsa_secp521r1_sha512</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0006</td>
              <td class="text-left" rowspan="1" colspan="1">0x0021</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">ed448</td>
            </tr>
          </tbody>
        </table>
<p id="section-15.1-13">The hash used for the MLS transcript hash is the one referenced in the
ciphersuite name.  In the ciphersuites defined above, "SHA256" and "SHA512"
refer to the SHA-256 and SHA-512 functions defined in <span>[<a href="#SHS" class="xref">SHS</a>]</span>.<a href="#section-15.1-13" class="pilcrow">¶</a></p>
<p id="section-15.1-14">It is advisable to keep the number of ciphersuites low to increase the chances
clients can interoperate in a federated environment, therefore the ciphersuites
only inlcude modern, yet well-established algorithms.  Depending on their
requirements, clients can choose between two security levels (roughly 128-bit
and 256-bit). Within the security levels clients can choose between faster
X25519/X448 curves and FIPS 140-2 compliant curves for Diffie-Hellman key
negotiations. Additionally clients that run predominantly on mobile processors
can choose ChaCha20Poly1305 over AES-GCM for performance reasons. Since
ChaCha20Poly1305 is not listed by FIPS 140-2 it is not paired with FIPS 140-2
compliant curves. The security level of symmetric encryption algorithms and hash
functions is paired with the security level of the curves.<a href="#section-15.1-14" class="pilcrow">¶</a></p>
<p id="section-15.1-15">The mandatory-to-implement ciphersuite for MLS 1.0 is
<code>MLS10\_128\_HPKE25519\_AES128GCM\_SHA256\_Ed25519</code> which uses
Curve25519 for key exchange, AES-128-GCM for HPKE, HKDF over SHA2-256,
AES for metadata masking, and Ed25519 for signatures.<a href="#section-15.1-15" class="pilcrow">¶</a></p>
<p id="section-15.1-16">Values with the first byte 255 (decimal) are reserved for Private Use.<a href="#section-15.1-16" class="pilcrow">¶</a></p>
<p id="section-15.1-17">New ciphersuite values are assigned by IANA as described in
<a href="#iana-considerations" class="xref">Section 15</a>.<a href="#section-15.1-17" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mls-extension-types">
<section id="section-15.2">
        <h3 id="name-mls-extension-types">
<a href="#section-15.2" class="section-number selfRef">15.2. </a><a href="#name-mls-extension-types" class="section-name selfRef">MLS Extension Types</a>
        </h3>
<p id="section-15.2-1">This registry lists identifiers for extensions to the MLS protocol.  The
extension type field is two bytes wide, so valid extension type values are in
the range 0x0000 to 0xffff.<a href="#section-15.2-1" class="pilcrow">¶</a></p>
<p id="section-15.2-2">Template:<a href="#section-15.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-15.2-3.1">Value: The numeric value of the extension type<a href="#section-15.2-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.2-3.2">Name: The name of the extension type<a href="#section-15.2-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.2-3.3">
            <p id="section-15.2-3.3.1">Message(s): The messages in which the extension may appear, drawn from the following
list:<a href="#section-15.2-3.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-15.2-3.3.2.1">KP: KeyPackage messages<a href="#section-15.2-3.3.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-15.2-3.3.2.2">GI: GroupInfo objects<a href="#section-15.2-3.3.2.2" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-15.2-3.4">Recommended: Whether support for this extension is recommended by the IETF MLS
WG.  Valid values are "Y" and "N".  The "Recommended" column is assigned a
value of "N" unless explicitly requested, and adding a value with a
"Recommended" value of "Y" requires Standards Action <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>.  IESG Approval
is REQUIRED for a Y-&gt;N transition.<a href="#section-15.2-3.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.2-3.5">Reference: The document where this extension is defined<a href="#section-15.2-3.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-15.2-4">Initial contents:<a href="#section-15.2-4" class="pilcrow">¶</a></p>
<table class="center" id="table-6">
          <caption><a href="#table-6" class="selfRef">Table 6</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">Name</th>
              <th class="text-left" rowspan="1" colspan="1">Message(s)</th>
              <th class="text-left" rowspan="1" colspan="1">Recommended</th>
              <th class="text-left" rowspan="1" colspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0000</td>
              <td class="text-left" rowspan="1" colspan="1">RESERVED</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">capabilities</td>
              <td class="text-left" rowspan="1" colspan="1">KP</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">lifetime</td>
              <td class="text-left" rowspan="1" colspan="1">KP</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">key_id</td>
              <td class="text-left" rowspan="1" colspan="1">KP</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0004</td>
              <td class="text-left" rowspan="1" colspan="1">parent_hash</td>
              <td class="text-left" rowspan="1" colspan="1">KP</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0005</td>
              <td class="text-left" rowspan="1" colspan="1">ratchet_tree</td>
              <td class="text-left" rowspan="1" colspan="1">GI</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0xff00  - 0xffff</td>
              <td class="text-left" rowspan="1" colspan="1">Reserved for Private Use</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
          </tbody>
        </table>
</section>
</div>
<div id="mls-credential-types">
<section id="section-15.3">
        <h3 id="name-mls-credential-types">
<a href="#section-15.3" class="section-number selfRef">15.3. </a><a href="#name-mls-credential-types" class="section-name selfRef">MLS Credential Types</a>
        </h3>
<p id="section-15.3-1">This registry lists identifiers for types of credentials that can be used for
authentication in the MLS protocol.  The extension type field is two bytes wide,
so valid extension type values are in the range 0x0000 to 0xffff.<a href="#section-15.3-1" class="pilcrow">¶</a></p>
<p id="section-15.3-2">Template:<a href="#section-15.3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-15.3-3.1">Value: The numeric value of the credential type<a href="#section-15.3-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.3-3.2">Name: The name of the credential type<a href="#section-15.3-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.3-3.3">Recommended: Whether support for this extension is recommended by the IETF MLS
WG.  Valid values are "Y" and "N".  The "Recommended" column is assigned a
value of "N" unless explicitly requested, and adding a value with a
"Recommended" value of "Y" requires Standards Action <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>.  IESG Approval
is REQUIRED for a Y-&gt;N transition.<a href="#section-15.3-3.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-15.3-3.4">Reference: The document where this extension is defined<a href="#section-15.3-3.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-15.3-4">Initial contents:<a href="#section-15.3-4" class="pilcrow">¶</a></p>
<table class="center" id="table-7">
          <caption><a href="#table-7" class="selfRef">Table 7</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">Name</th>
              <th class="text-left" rowspan="1" colspan="1">Recommended</th>
              <th class="text-left" rowspan="1" colspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0000</td>
              <td class="text-left" rowspan="1" colspan="1">RESERVED</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">basic</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">x509</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0xff00  - 0xffff</td>
              <td class="text-left" rowspan="1" colspan="1">Reserved for Private Use</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
          </tbody>
        </table>
</section>
</div>
<div id="de">
<section id="section-15.4">
        <h3 id="name-mls-designated-expert-pool">
<a href="#section-15.4" class="section-number selfRef">15.4. </a><a href="#name-mls-designated-expert-pool" class="section-name selfRef">MLS Designated Expert Pool</a>
        </h3>
<p id="section-15.4-1">Specification Required <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span> registry requests are registered
after a three-week review period on the MLS DEs' mailing list:
<a href="mailto:mls-reg-review@ietf.org">mls-reg-review@ietf.org</a>, on the advice of one or more of the MLS DEs. However,
to allow for the allocation of values prior to publication, the MLS
DEs may approve registration once they are satisfied that such a
specification will be published.<a href="#section-15.4-1" class="pilcrow">¶</a></p>
<p id="section-15.4-2">Registration requests sent to the MLS DEs mailing list for review
SHOULD use an appropriate subject (e.g., "Request to register value
in MLS Bar registry").<a href="#section-15.4-2" class="pilcrow">¶</a></p>
<p id="section-15.4-3">Within the review period, the MLS DEs will either approve or deny
the registration request, communicating this decision to the MLS DEs
mailing list and IANA. Denials SHOULD include an explanation and, if
applicable, suggestions as to how to make the request successful.
Registration requests that are undetermined for a period longer than
21 days can be brought to the IESG's attention for resolution using
the <a href="mailto:iesg@ietf.org">iesg@ietf.org</a> mailing list.<a href="#section-15.4-3" class="pilcrow">¶</a></p>
<p id="section-15.4-4">Criteria that SHOULD be applied by the MLS DEs includes determining
whether the proposed registration duplicates existing functionality,
whether it is likely to be of general applicability or useful only
for a single application, and whether the registration description
is clear. For example, the MLS DEs will apply the ciphersuite-related
advisory found in <a href="#ciphersuites" class="xref">Section 6.1</a>.<a href="#section-15.4-4" class="pilcrow">¶</a></p>
<p id="section-15.4-5">IANA MUST only accept registry updates from the MLS DEs and SHOULD
direct all requests for registration to the MLS DEs' mailing list.<a href="#section-15.4-5" class="pilcrow">¶</a></p>
<p id="section-15.4-6">It is suggested that multiple MLS DEs be appointed who are able to
represent the perspectives of different applications using this
specification, in order to enable broadly informed review of
registration decisions. In cases where a registration decision could
be perceived as creating a conflict of interest for a particular
MLS DE, that MLS DE SHOULD defer to the judgment of the other MLS DEs.<a href="#section-15.4-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="contributors">
<section id="section-16">
      <h2 id="name-contributors">
<a href="#section-16" class="section-number selfRef">16. </a><a href="#name-contributors" class="section-name selfRef">Contributors</a>
      </h2>
<ul class="normal">
<li class="normal" id="section-16-1.1">
          <p id="section-16-1.1.1">Joel Alwen<a href="#section-16-1.1.1" class="pilcrow">¶</a></p>
<p id="section-16-1.1.2">
Wickr<a href="#section-16-1.1.2" class="pilcrow">¶</a></p>
<p id="section-16-1.1.3">
joel.alwen@wickr.com<a href="#section-16-1.1.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.2">
          <p id="section-16-1.2.1">Karthikeyan Bhargavan<a href="#section-16-1.2.1" class="pilcrow">¶</a></p>
<p id="section-16-1.2.2">
INRIA<a href="#section-16-1.2.2" class="pilcrow">¶</a></p>
<p id="section-16-1.2.3">
karthikeyan.bhargavan@inria.fr<a href="#section-16-1.2.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.3">
          <p id="section-16-1.3.1">Cas Cremers<a href="#section-16-1.3.1" class="pilcrow">¶</a></p>
<p id="section-16-1.3.2">
University of Oxford<a href="#section-16-1.3.2" class="pilcrow">¶</a></p>
<p id="section-16-1.3.3">
cas.cremers@cs.ox.ac.uk<a href="#section-16-1.3.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.4">
          <p id="section-16-1.4.1">Alan Duric<a href="#section-16-1.4.1" class="pilcrow">¶</a></p>
<p id="section-16-1.4.2">
Wire<a href="#section-16-1.4.2" class="pilcrow">¶</a></p>
<p id="section-16-1.4.3">
alan@wire.com<a href="#section-16-1.4.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.5">
          <p id="section-16-1.5.1">Britta Hale<a href="#section-16-1.5.1" class="pilcrow">¶</a></p>
<p id="section-16-1.5.2">
Naval Postgraduate School<a href="#section-16-1.5.2" class="pilcrow">¶</a></p>
<p id="section-16-1.5.3">
britta.hale@nps.edu<a href="#section-16-1.5.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.6">
          <p id="section-16-1.6.1">Srinivas Inguva<a href="#section-16-1.6.1" class="pilcrow">¶</a></p>
<p id="section-16-1.6.2">
Twitter<a href="#section-16-1.6.2" class="pilcrow">¶</a></p>
<p id="section-16-1.6.3">
singuva@twitter.com<a href="#section-16-1.6.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.7">
          <p id="section-16-1.7.1">Konrad Kohbrok<a href="#section-16-1.7.1" class="pilcrow">¶</a></p>
<p id="section-16-1.7.2">
Aalto University<a href="#section-16-1.7.2" class="pilcrow">¶</a></p>
<p id="section-16-1.7.3">
konrad.kohbrok@datashrine.de<a href="#section-16-1.7.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.8">
          <p id="section-16-1.8.1">Albert Kwon<a href="#section-16-1.8.1" class="pilcrow">¶</a></p>
<p id="section-16-1.8.2">
MIT<a href="#section-16-1.8.2" class="pilcrow">¶</a></p>
<p id="section-16-1.8.3">
kwonal@mit.edu<a href="#section-16-1.8.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.9">
          <p id="section-16-1.9.1">Brendan McMillion<a href="#section-16-1.9.1" class="pilcrow">¶</a></p>
<p id="section-16-1.9.2">
Cloudflare<a href="#section-16-1.9.2" class="pilcrow">¶</a></p>
<p id="section-16-1.9.3">
brendan@cloudflare.com<a href="#section-16-1.9.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.10">
          <p id="section-16-1.10.1">Eric Rescorla<a href="#section-16-1.10.1" class="pilcrow">¶</a></p>
<p id="section-16-1.10.2">
Mozilla<a href="#section-16-1.10.2" class="pilcrow">¶</a></p>
<p id="section-16-1.10.3">
ekr@rtfm.com<a href="#section-16-1.10.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.11">
          <p id="section-16-1.11.1">Michael Rosenberg<a href="#section-16-1.11.1" class="pilcrow">¶</a></p>
<p id="section-16-1.11.2">
Trail of Bits<a href="#section-16-1.11.2" class="pilcrow">¶</a></p>
<p id="section-16-1.11.3">
michael.rosenberg@trailofbits.com<a href="#section-16-1.11.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-16-1.12">
          <p id="section-16-1.12.1">Thyla van der Merwe<a href="#section-16-1.12.1" class="pilcrow">¶</a></p>
<p id="section-16-1.12.2">
Royal Holloway, University of London<a href="#section-16-1.12.2" class="pilcrow">¶</a></p>
<p id="section-16-1.12.3">
thyla.van.der@merwe.tech<a href="#section-16-1.12.3" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<section id="section-17">
      <h2 id="name-references">
<a href="#section-17" class="section-number selfRef">17. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-17.1">
        <h3 id="name-normative-references">
<a href="#section-17.1" class="section-number selfRef">17.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.irtf-cfrg-hpke">[I-D.irtf-cfrg-hpke]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span><span class="refAuthor">, Bhargavan, K.</span><span class="refAuthor">, Lipp, B.</span><span class="refAuthor">, and C. Wood</span>, <span class="refTitle">"Hybrid Public Key Encryption"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-hpke-05</span>, <time datetime="2020-07-30" class="refDate">30 July 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-irtf-cfrg-hpke-05.txt">http://www.ietf.org/internet-drafts/draft-irtf-cfrg-hpke-05.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8126">[RFC8126]</dt>
        <dd>
<span class="refAuthor">Cotton, M.</span><span class="refAuthor">, Leiba, B.</span><span class="refAuthor">, and T. Narten</span>, <span class="refTitle">"Guidelines for Writing an IANA Considerations Section in RFCs"</span>, <span class="seriesInfo">BCP 26</span>, <span class="seriesInfo">RFC 8126</span>, <span class="seriesInfo">DOI 10.17487/RFC8126</span>, <time datetime="2017-06" class="refDate">June 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8126">https://www.rfc-editor.org/info/rfc8126</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
      <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8446">https://www.rfc-editor.org/info/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-17.2">
        <h3 id="name-informative-references">
<a href="#section-17.2" class="section-number selfRef">17.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="art">[art]</dt>
        <dd>
<span class="refAuthor">Cohn-Gordon, K.</span><span class="refAuthor">, Cremers, C.</span><span class="refAuthor">, Garratt, L.</span><span class="refAuthor">, Millican, J.</span><span class="refAuthor">, and K. Milner</span>, <span class="refTitle">"On Ends-to-Ends Encryption: Asynchronous Group Messaging with Strong Security Guarantees"</span>, <time datetime="2018-01-18" class="refDate">18 January 2018</time>, <span>&lt;<a href="https://eprint.iacr.org/2017/666.pdf">https://eprint.iacr.org/2017/666.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="CLINIC">[CLINIC]</dt>
        <dd>
<span class="refAuthor">Miller, B.</span><span class="refAuthor">, Huang, L.</span><span class="refAuthor">, Joseph, A.</span><span class="refAuthor">, and J. Tygar</span>, <span class="refTitle">"I Know Why You Went to the Clinic: Risks and Realization of HTTPS Traffic Analysis"</span>, <span class="seriesInfo">Privacy Enhancing Technologies pp. 143-163</span>, <span class="seriesInfo">DOI 10.1007/978-3-319-08506-7_8</span>, <time datetime="2014" class="refDate">2014</time>, <span>&lt;<a href="https://doi.org/10.1007/978-3-319-08506-7_8">https://doi.org/10.1007/978-3-319-08506-7_8</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="doubleratchet">[doubleratchet]</dt>
        <dd>
<span class="refAuthor">Cohn-Gordon, K.</span><span class="refAuthor">, Cremers, C.</span><span class="refAuthor">, Dowling, B.</span><span class="refAuthor">, Garratt, L.</span><span class="refAuthor">, and D. Stebila</span>, <span class="refTitle">"A Formal Security Analysis of the Signal Messaging Protocol"</span>, <span class="seriesInfo">2017 IEEE European Symposium on Security and Privacy (EuroS&amp;P)</span>, <span class="seriesInfo">DOI 10.1109/eurosp.2017.27</span>, <time datetime="2017-04" class="refDate">April 2017</time>, <span>&lt;<a href="https://doi.org/10.1109/eurosp.2017.27">https://doi.org/10.1109/eurosp.2017.27</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="HCJ16">[HCJ16]</dt>
        <dd>
<span class="refAuthor">Husák, M.</span><span class="refAuthor">, Čermák, M.</span><span class="refAuthor">, Jirsík, T.</span><span class="refAuthor">, and P. Čeleda</span>, <span class="refTitle">"HTTPS traffic analysis and client identification using passive SSL/TLS fingerprinting"</span>, <span class="seriesInfo">EURASIP Journal on Information Security Vol. 2016</span>, <span class="seriesInfo">DOI 10.1186/s13635-016-0030-7</span>, <time datetime="2016-02" class="refDate">February 2016</time>, <span>&lt;<a href="https://doi.org/10.1186/s13635-016-0030-7">https://doi.org/10.1186/s13635-016-0030-7</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-mls-architecture">[I-D.ietf-mls-architecture]</dt>
        <dd>
<span class="refAuthor">Omara, E.</span><span class="refAuthor">, Beurdouche, B.</span><span class="refAuthor">, Rescorla, E.</span><span class="refAuthor">, Inguva, S.</span><span class="refAuthor">, Kwon, A.</span><span class="refAuthor">, and A. Duric</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Architecture"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mls-architecture-05</span>, <time datetime="2020-07-26" class="refDate">26 July 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-mls-architecture-05.txt">http://www.ietf.org/internet-drafts/draft-ietf-mls-architecture-05.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-trans-rfc6962-bis">[I-D.ietf-trans-rfc6962-bis]</dt>
        <dd>
<span class="refAuthor">Laurie, B.</span><span class="refAuthor">, Langley, A.</span><span class="refAuthor">, Kasper, E.</span><span class="refAuthor">, Messeri, E.</span><span class="refAuthor">, and R. Stradling</span>, <span class="refTitle">"Certificate Transparency Version 2.0"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-trans-rfc6962-bis-34</span>, <time datetime="2019-11-04" class="refDate">4 November 2019</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-trans-rfc6962-bis-34.txt">http://www.ietf.org/internet-drafts/draft-ietf-trans-rfc6962-bis-34.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8032">[RFC8032]</dt>
        <dd>
<span class="refAuthor">Josefsson, S.</span><span class="refAuthor"> and I. Liusvaara</span>, <span class="refTitle">"Edwards-Curve Digital Signature Algorithm (EdDSA)"</span>, <span class="seriesInfo">RFC 8032</span>, <span class="seriesInfo">DOI 10.17487/RFC8032</span>, <time datetime="2017-01" class="refDate">January 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8032">https://www.rfc-editor.org/info/rfc8032</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SECG">[SECG]</dt>
        <dd>
<span class="refTitle">"Elliptic Curve Cryptography, Standards for Efficient Cryptography Group, ver. 2"</span>, <time datetime="2009" class="refDate">2009</time>, <span>&lt;<a href="https://secg.org/sec1-v2.pdf">https://secg.org/sec1-v2.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SHS">[SHS]</dt>
        <dd>
<span class="refAuthor">Dang, Q.</span>, <span class="refTitle">"Secure Hash Standard"</span>, <span class="seriesInfo">National Institute of Standards and Technology report</span>, <span class="seriesInfo">DOI 10.6028/nist.fips.180-4</span>, <time datetime="2015-07" class="refDate">July 2015</time>, <span>&lt;<a href="https://doi.org/10.6028/nist.fips.180-4">https://doi.org/10.6028/nist.fips.180-4</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="signal">[signal]</dt>
      <dd>
<span class="refAuthor">Perrin(ed), T.</span><span class="refAuthor"> and M. Marlinspike</span>, <span class="refTitle">"The Double Ratchet Algorithm"</span>, <time datetime="2016-11-20" class="refDate">20 November 2016</time>, <span>&lt;<a href="https://www.signal.org/docs/specifications/doubleratchet/">https://www.signal.org/docs/specifications/doubleratchet/</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="tree-math">
<section id="section-appendix.a">
      <h2 id="name-tree-math">
<a href="#section-appendix.a" class="section-number selfRef">Appendix A. </a><a href="#name-tree-math" class="section-name selfRef">Tree Math</a>
      </h2>
<p id="section-appendix.a-1">One benefit of using left-balanced trees is that they admit a simple
flat array representation.  In this representation, leaf nodes are
even-numbered nodes, with the n-th leaf at 2*n.  Intermediate nodes
are held in odd-numbered nodes.  For example, an 11-element tree has
the following structure:<a href="#section-appendix.a-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-appendix.a-2">
<pre>
                                             X
                     X
         X                       X                       X
   X           X           X           X           X
X     X     X     X     X     X     X     X     X     X     X
0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20
</pre><a href="#section-appendix.a-2" class="pilcrow">¶</a>
</div>
<p id="section-appendix.a-3">This allows us to compute relationships between tree nodes simply by
manipulating indices, rather than having to maintain complicated
structures in memory, even for partial trees. The basic
rule is that the high-order bits of parent and child nodes have the
following relation (where <code>x</code> is an arbitrary bit string):<a href="#section-appendix.a-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-appendix.a-4">
<pre>
parent=01x =&gt; left=00x, right=10x
</pre><a href="#section-appendix.a-4" class="pilcrow">¶</a>
</div>
<p id="section-appendix.a-5">The following python code demonstrates the tree computations
necessary for MLS.  Test vectors can be derived from the diagram
above.<a href="#section-appendix.a-5" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-appendix.a-6">
<pre>
# The exponent of the largest power of 2 less than x. Equivalent to:
#   int(math.floor(math.log(x, 2)))
def log2(x):
    if x == 0:
        return 0

    k = 0
    while (x &gt;&gt; k) &gt; 0:
        k += 1
    return k-1

# The level of a node in the tree. Leaves are level 0, their parents are
# level 1, etc. If a node's children are at different levels, then its
# level is the max level of its children plus one.
def level(x):
    if x &amp; 0x01 == 0:
        return 0

    k = 0
    while ((x &gt;&gt; k) &amp; 0x01) == 1:
        k += 1
    return k

# The number of nodes needed to represent a tree with n leaves.
def node_width(n):
    if n == 0:
        return 0
    else:
        return 2*(n - 1) + 1

# The index of the root node of a tree with n leaves.
def root(n):
    w = node_width(n)
    return (1 &lt;&lt; log2(w)) - 1

# The left child of an intermediate node. Note that because the tree is
# left-balanced, there is no dependency on the size of the tree.
def left(x):
    k = level(x)
    if k == 0:
        raise Exception('leaf node has no children')

    return x ^ (0x01 &lt;&lt; (k - 1))

# The right child of an intermediate node. Depends on the number of
# leaves because the straightforward calculation can take you beyond the
# edge of the tree.
def right(x, n):
    k = level(x)
    if k == 0:
        raise Exception('leaf node has no children')

    r = x ^ (0x03 &lt;&lt; (k - 1))
    while r &gt;= node_width(n):
        r = left(r)
    return r

# The immediate parent of a node. May be beyond the right edge of the
# tree.
def parent_step(x):
    k = level(x)
    b = (x &gt;&gt; (k + 1)) &amp; 0x01
    return (x | (1 &lt;&lt; k)) ^ (b &lt;&lt; (k + 1))

# The parent of a node. As with the right child calculation, we have to
# walk back until the parent is within the range of the tree.
def parent(x, n):
    if x == root(n):
        raise Exception('root node has no parent')

    p = parent_step(x)
    while p &gt;= node_width(n):
        p = parent_step(p)
    return p

# The other child of the node's parent.
def sibling(x, n):
    p = parent(x, n)
    if x &lt; p:
        return right(p, n)
    else:
        return left(p)

# The direct path of a node, ordered from leaf to root.
def direct_path(x, n):
    r = root(n)
    if x == r:
        return []

    d = []
    while x != r:
        x = parent(x, n)
        d.append(x)
    return d

# The copath of a node, ordered from leaf to root.
def copath(x, n):
    if x == root(n):
        return []

    d = direct_path(x, n)
    d.insert(0, x)
    d.pop()
    return [sibling(y, n) for y in d]

# The common ancestor of two nodes is the lowest node that is in the
# direct paths of both leaves.
def common_ancestor_semantic(x, y, n):
    dx = set([x]) | set(direct_path(x, n))
    dy = set([y]) | set(direct_path(y, n))
    dxy = dx &amp; dy
    if len(dxy) == 0:
        raise Exception('failed to find common ancestor')

    return min(dxy, key=level)

# The common ancestor of two nodes is the lowest node that is in the
# direct paths of both leaves.
def common_ancestor_direct(x, y, _):
    # Handle cases where one is an ancestor of the other
    lx, ly = level(x)+1, level(y)+1
    if (lx &lt;= ly) and (x&gt;&gt;ly == y&gt;&gt;ly):
      return y
    elif (ly &lt;= lx) and (x&gt;&gt;lx == y&gt;&gt;lx):
      return x

    # Handle other cases
    xn, yn = x, y
    k = 0
    while xn != yn:
       xn, yn = xn &gt;&gt; 1, yn &gt;&gt; 1
       k += 1
    return (xn &lt;&lt; k) + (1 &lt;&lt; (k-1)) - 1
</pre><a href="#section-appendix.a-6" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="authors-addresses">
<section id="section-appendix.b">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Richard Barnes</span></div>
<div dir="auto" class="left"><span class="org">Cisco</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rlb@ipv.sx" class="email">rlb@ipv.sx</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Benjamin Beurdouche</span></div>
<div dir="auto" class="left"><span class="org">Inria</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:benjamin.beurdouche@inria.fr" class="email">benjamin.beurdouche@inria.fr</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Jon Millican</span></div>
<div dir="auto" class="left"><span class="org">Facebook</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:jmillican@fb.com" class="email">jmillican@fb.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Emad Omara</span></div>
<div dir="auto" class="left"><span class="org">Google</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:emadomara@google.com" class="email">emadomara@google.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Katriel Cohn-Gordon</span></div>
<div dir="auto" class="left"><span class="org">University of Oxford</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:me@katriel.co.uk" class="email">me@katriel.co.uk</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div dir="auto" class="left"><span class="org">Wire</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:raphael@wire.com" class="email">raphael@wire.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
